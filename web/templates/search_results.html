{% if config.rag_enabled and rag_response %}
    <div class="rag-response" style="margin-top: 2rem; padding: 1rem; background-color: #e8f4fd; border-left: 4px solid #2196F3; border-radius: 4px;">
        <h3>Ответ ассистента (RAG):</h3>
        <p>{{ rag_response | safe }}</p>
        <details>
            <summary>Подробнее: использованный контекст (топ-{{ config.rag_top_k }} результатов)</summary>
            <ul>
                {% for result, score in results[:config.rag_top_k] %}
                    <li><strong>{{ result.metadata.source if result.metadata else 'N/A' }}</strong>: {{ result.content[:200] }}...</li>
                {% endfor %}
            </ul>
        </details>
    </div>
{% endif %}
{% if results %}
    <h2>Результаты поиска ({{ results|length }}):</h2>
    {% for result, score in results %}
        <article>
            <header>
                <b>Источник:</b> 
                {% if result.source %}
                    {{ result.source }}
                {% elif result.metadata.source %}
                    {{ result.metadata.source }}
                {% else %}
                    N/A
                {% endif %}
                | <b>Сходство:</b> <mark>{{ '%.4f'|format(score) }}</mark>
                {% if 'original_score' in result and 'reranker_score' in result %}
                    | <b>Оригинал:</b> <mark>{{ '%.4f'|format(result.original_score) }}</mark>
                    | <b>Reranker:</b> <mark>{{ '%.4f'|format(result.reranker_score) }}</mark>
                {% endif %}
            </header>
            
            <!-- Отображаем содержимое чанка -->
            <p>{{ result.content or result.page_content or "Содержимое недоступно" }}</p>
            
            <!-- Отображаем микро-чанки, если они есть -->
            {% if result.micro_contents %}
                <details>
                    <summary>Микро-чанки ({{ result.micro_contents|length }})</summary>
                    <ul>
                        {% for micro_content in result.micro_contents %}
                            <li>{{ micro_content }}</li>
                        {% endfor %}
                    </ul>
                </details>
            {% endif %}
            
            <!-- Отображаем метаданные -->
            {% if result.metadata %}
                <details>
                    <summary>Метаданные</summary>
                    <ul>
                        {% for key, value in result.metadata.items() %}
                            <li><b>{{ key }}:</b> {{ value }}</li>
                        {% endfor %}
                    </ul>
                </details>
            {% endif %}
        </article>
    {% endfor %}
{% elif request.method == 'POST' %}
     <p>По вашему запросу ничего не найдено в коллекции '{{ selected_collection }}'.</p>
{% endif %}
{% if error %}
    <p style="color: red;">Ошибка: {{ error }}</p>
{% endif %}