<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Индексация документов</title>
    <link rel="stylesheet" href="/static/simple.min.css">
    <style>
        .status-message {
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 4px;
        }
        .status-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status-error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status-info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .controls-section {
            margin: 1rem 0;
            padding: 1rem;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .collection-list {
            margin: 1rem 0;
        }
        .collection-item {
            padding: 0.5rem;
            margin: 0.25rem 0;
            border: 1px solid #eee;
            border-radius: 3px;
            background-color: #f9f9f9;
        }
    </style>
</head>
<body>
    <header>
        <h1>Индексация и Конвертация документов</h1>
        <nav>
            <a href="/api/admin/settings/">Настройки</a> |
            <a href="/api/indexing/">Индексация</a> |
            <a href="/api/search/">Поиск</a>
        </nav>
    </header>
    
    <main>
        {% if status_message %}
            <div class="status-message status-{{ status_type }}">
                {{ status_message }}
            </div>
        {% endif %}
        
        {% if error %}
            <div class="status-message status-error">
                {{ error }}
            </div>
        {% endif %}
        
        <div class="controls-section">
            <h2>Конфигурация индексации</h2>
            <form id="update-paths-form" method="post" action="/api/indexing/update-paths">
                <p><strong>Папка для индексации:</strong></p>
                <input type="text" name="indexing_folder" id="indexing_folder" value="{{ config.folder_path }}" style="width: 100%; padding: 0.5rem; margin: 0.25rem 0;"/>
                
                <p><strong>Входная директория для конвертации:</strong></p>
                <input type="text" name="input_pdf_dir" id="input_pdf_dir" value="{{ config.mineru_input_pdf_dir }}" style="width: 100%; padding: 0.5rem; margin: 0.25rem 0;"/>
                
                <p><strong>Выходная директория для сохранения MD:</strong></p>
                <input type="text" name="output_md_dir" id="output_md_dir" value="{{ config.mineru_output_md_dir }}" style="width: 100%; padding: 0.5rem; margin: 0.25rem 0;"/>
                
                <button type="submit">Обновить пути</button>
            </form>
            <div id="paths-status" style="margin-top: 1rem;"></div>
            
            <p><strong>Имя коллекции:</strong> {{ config.collection_name }}</p>
            <p><strong>Модель эмбеддингов:</strong> {{ config.current_hf_model }}</p>
            <p><strong>Устройство:</strong> {{ config.device }}</p>
        </div>
        
        <div class="controls-section">
            <h2>Запуск процессов</h2>
            
            <div>
                <h3>Индексация документов</h3>
                <button id="run-indexing-btn" onclick="runIndexing()">Запустить индексацию</button>
                <div id="indexing-status" style="margin-top: 1rem;"></div>
            </div>
            
            <hr style="margin: 1rem 0;">
            
            <div>
                <h3>Конвертация файлов</h3>
                <p><strong>Входная директория:</strong> {{ config.mineru_input_pdf_dir }}</p>
                <p><strong>Выходная директория:</strong> {{ config.mineru_output_md_dir }}</p>
                <button id="process-files-btn" onclick="processFiles()">Запустить конвертацию</button>
                <button id="stop-conversion-btn" onclick="stopConversion()" style="margin-left: 10px; background-color: #dc3545; color: white;">Остановить конвертацию</button>
                <button id="refresh-progress-btn" onclick="getConversionProgress()" style="margin-left: 10px;">Обновить прогресс</button>
                <div id="conversion-status" style="margin-top: 1rem;"></div>
                
                <div id="conversion-progress" style="margin-top: 1rem; padding: 1rem; border: 1px solid #ddd; background-color: #f9f9f9;">
                    <h4>Прогресс конвертации</h4>
                    <div id="progress-summary">
                        <p>Загружается прогресс...</p>
                    </div>
                    <div style="margin: 0.5rem 0; display: flex; gap: 10px; align-items: center;">
                        <label for="file-status-filter">Фильтр: </label>
                        <select id="file-status-filter" onchange="filterAndDisplayFiles()" style="padding: 0.25rem;">
                            <option value="">Все файлы</option>
                            <option value="converted">Обработано</option>
                            <option value="error">Ошибки</option>
                            <option value="in_progress">В процессе</option>
                            <option value="pending">Ожидает</option>
                        </select>
                        <label for="files-display-limit">Показывать: </label>
                        <input type="number" id="files-display-limit" value="50" min="1" max="500" style="width: 70px; padding: 0.25rem;" onchange="filterAndDisplayFiles()" title="Количество файлов для отображения">
                        <span>файлов</span>
                    </div>
                    <div id="file-list" style="margin-top: 1rem; max-height: 300px; overflow-y: auto;">
                        <!-- Список файлов будет загружен здесь -->
                    </div>
                </div>
            </div>
        </div>
        
        <div class="controls-section">
            <h2>Доступные коллекции</h2>
            {% if collections %}
                <ul class="collection-list">
                    {% for collection in collections %}
                        <li class="collection-item">
                            <span>{{ collection.name }} (векторов: {{ collection.points_count }})</span>
                            <button class="delete-collection-btn" onclick="deleteCollection('{{ collection.name }}')" style="float: right; margin-left: 10px;">Удалить</button>
                        </li>
                    {% endfor %}
                </ul>
            {% else %}
                <p>Нет доступных коллекций</p>
            {% endif %}
        </div>
    </main>
    
    <script>
        async function runIndexing() {
            const button = document.getElementById('run-indexing-btn');
            const statusDiv = document.getElementById('indexing-status');
            
            button.disabled = true;
            button.textContent = 'Запуск...';
            statusDiv.textContent = 'Отправка запроса на индексацию...';
            
            try {
                const response = await fetch('/api/indexing/run-indexing', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                const data = await response.json();
                
                if (data.status === 'indexing_started') {
                    statusDiv.innerHTML = '<span style="color: green;">✓</span> ' + data.message;
                } else {
                    statusDiv.innerHTML = '<span style="color: red;">✗ Ошибка:</span> ' + data.message;
                }
            } catch (error) {
                statusDiv.innerHTML = '<span style="color: red;">✗ Ошибка подключения:</span> ' + error.message;
            } finally {
                button.disabled = false;
                button.textContent = 'Запустить индексацию';
            }
        }
        
        async function processFiles() {
            const button = document.getElementById('process-files-btn');
            const statusDiv = document.getElementById('conversion-status');
            
            button.disabled = true;
            button.textContent = 'Запуск...';
            statusDiv.textContent = 'Отправка запроса на конвертацию...';
            
            try {
                const response = await fetch('/api/indexing/process-files', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                const data = await response.json();
                
                if (data.status === 'processing_started') {
                    statusDiv.innerHTML = '<span style="color: green;">✓</span> ' + data.message;
                } else {
                    statusDiv.innerHTML = '<span style="color: red;">✗ Ошибка:</span> ' + data.message;
                }
            } catch (error) {
                statusDiv.innerHTML = '<span style="color: red;">✗ Ошибка подключения:</span> ' + error.message;
            } finally {
                button.disabled = false;
                button.textContent = 'Запустить конвертацию';
            }
        }
        
        async function stopConversion() {
            const button = document.getElementById('stop-conversion-btn');
            const statusDiv = document.getElementById('conversion-status');
            
            if (!confirm('Вы уверены, что хотите остановить процесс конвертации?')) {
                return;
            }
            
            button.disabled = true;
            button.textContent = 'Остановка...';
            statusDiv.textContent = 'Отправка запроса на остановку конвертации...';
            
            try {
                const response = await fetch('/api/indexing/stop-conversion', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                const data = await response.json();
                
                if (data.status === 'stopped') {
                    statusDiv.innerHTML = '<span style="color: green;">✓</span> ' + data.message;
                } else {
                    statusDiv.innerHTML = '<span style="color: red;">✗ Ошибка:</span> ' + data.message;
                }
            } catch (error) {
                statusDiv.innerHTML = '<span style="color: red;">✗ Ошибка подключения:</span> ' + error.message;
            } finally {
                button.disabled = false;
                button.textContent = 'Остановить конвертацию';
            }
        }
        
        async function getConversionProgress() {
            const progressDiv = document.getElementById('progress-summary');
            const fileListDiv = document.getElementById('file-list');
            const button = document.getElementById('refresh-progress-btn');
            const statusFilter = document.getElementById('file-status-filter').value;
            const displayLimit = parseInt(document.getElementById('files-display-limit').value) || 50;
            
            button.disabled = true;
            button.textContent = 'Загрузка...';
            
            try {
                const response = await fetch('/api/indexing/progress', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                const data = await response.json();
                
                // Обновляем сводку прогресса
                progressDiv.innerHTML = `
                    <p><strong>Всего файлов:</strong> ${data.total}</p>
                    <p><strong>Обработано:</strong> ${data.converted} | <strong>Ошибки:</strong> ${data.errors} | <strong>В процессе:</strong> ${data.in_progress} | <strong>Ожидает:</strong> ${data.pending}</p>
                    <div style="height: 20px; background-color: #eee; border-radius: 10px; overflow: hidden;">
                        <div style="height: 100%; width: ${data.total > 0 ? (data.converted / data.total * 100) : 0}%; background-color: #28a745; float: left;"></div>
                        <div style="height: 100%; width: ${data.total > 0 ? (data.errors / data.total * 100) : 0}%; background-color: #dc3545; float: left;"></div>
                        <div style="height: 100%; width: ${data.total > 0 ? (data.in_progress / data.total * 100) : 0}%; background-color: #ffc107; float: left;"></div>
                    </div>
                `;
                
                // Обновляем список файлов
                if (Object.keys(data.files).length > 0) {
                    fileListDiv.innerHTML = '<h5>Файлы:</h5><ul style="list-style-type: none; padding: 0;">';
                    for (const [filePath, fileInfo] of Object.entries(data.files)) {
                        let statusClass = '';
                        let statusIcon = '';
                        if (fileInfo.status === 'converted') {
                            statusClass = 'style="color: green;"';
                            statusIcon = '✓ ';
                        } else if (fileInfo.status === 'error') {
                            statusClass = 'style="color: red;"';
                            statusIcon = '✗ ';
                        } else if (fileInfo.status === 'in_progress') {
                            statusClass = 'style="color: orange;"';
                            statusIcon = '⏳ ';
                        } else {
                            statusClass = 'style="color: gray;"';
                            statusIcon = '○ ';
                        }
                        
                        fileListDiv.innerHTML += `<li ${statusClass}>${statusIcon}${filePath.split('\\').pop().split('/').pop()} (${fileInfo.status})</li>`;
                    }
                    fileListDiv.innerHTML += '</ul>';
                } else {
                    fileListDiv.innerHTML = '<p>Нет отслеживаемых файлов</p>';
                }
            } catch (error) {
                progressDiv.innerHTML = '<span style="color: red;">Ошибка загрузки прогресса: ' + error.message + '</span>';
                fileListDiv.innerHTML = '';
            } finally {
                button.disabled = false;
                button.textContent = 'Обновить прогресс';
            }
        }
        
        // Function to filter and display files based on current filter settings
        function filterAndDisplayFiles() {
            const fileListDiv = document.getElementById('file-list');
            const statusFilter = document.getElementById('file-status-filter').value;
            const displayLimit = parseInt(document.getElementById('files-display-limit').value) || 50;
            
            // We need to make sure we have the conversionData variable defined
            if (window.conversionData && Object.keys(window.conversionData.files).length > 0) {
                fileListDiv.innerHTML = '<h5>Файлы:</h5><ul style="list-style-type: none; padding: 0;">';
                
                let filteredFiles = Object.entries(window.conversionData.files);
                
                // Apply status filter if specified
                if (statusFilter) {
                    filteredFiles = filteredFiles.filter(([filePath, fileInfo]) => fileInfo.status === statusFilter);
                }
                
                // Apply display limit
                if (displayLimit > 0) {
                    filteredFiles = filteredFiles.slice(0, displayLimit);
                }
                
                for (const [filePath, fileInfo] of filteredFiles) {
                    let statusClass = '';
                    let statusIcon = '';
                    if (fileInfo.status === 'converted') {
                        statusClass = 'style="color: green;"';
                        statusIcon = '✓ ';
                    } else if (fileInfo.status === 'error') {
                        statusClass = 'style="color: red;"';
                        statusIcon = '✗ ';
                    } else if (fileInfo.status === 'in_progress') {
                        statusClass = 'style="color: orange;"';
                        statusIcon = '⏳ ';
                    } else {
                        statusClass = 'style="color: gray;"';
                        statusIcon = '○ ';
                    }
                    
                    fileListDiv.innerHTML += `<li ${statusClass}>${statusIcon}${filePath.split('\\\\').pop().split('/').pop()} (${fileInfo.status})</li>`;
                }
                
                if (filteredFiles.length === 0) {
                    fileListDiv.innerHTML += '<li>Нет файлов для отображения с выбранным фильтром</li>';
                }
                
                fileListDiv.innerHTML += '</ul>';
            } else {
                fileListDiv.innerHTML = '<p>Нет отслеживаемых файлов</p>';
            }
        }
        
        // Enhanced getConversionProgress that stores data globally
        async function getConversionProgress() {
            const progressDiv = document.getElementById('progress-summary');
            const button = document.getElementById('refresh-progress-btn');
            
            button.disabled = true;
            button.textContent = 'Загрузка...';
            
            try {
                const response = await fetch('/api/indexing/progress', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                // Store the data globally so we can filter it
                window.conversionData = await response.json();
                const data = window.conversionData;
                
                // Обновляем сводку прогресса
                progressDiv.innerHTML = `
                    <p><strong>Всего файлов:</strong> ${data.total}</p>
                    <p><strong>Обработано:</strong> ${data.converted} | <strong>Ошибки:</strong> ${data.errors} | <strong>В процессе:</strong> ${data.in_progress} | <strong>Ожидает:</strong> ${data.pending}</p>
                    <div style="height: 20px; background-color: #eee; border-radius: 10px; overflow: hidden;">
                        <div style="height: 100%; width: ${data.total > 0 ? (data.converted / data.total * 100) : 0}%; background-color: #28a745; float: left;"></div>
                        <div style="height: 100%; width: ${data.total > 0 ? (data.errors / data.total * 100) : 0}%; background-color: #dc3545; float: left;"></div>
                        <div style="height: 100%; width: ${data.total > 0 ? (data.in_progress / data.total * 100) : 0}%; background-color: #ffc107; float: left;"></div>
                    </div>
                `;
                
                // Now apply filtering and display
                filterAndDisplayFiles();
            } catch (error) {
                progressDiv.innerHTML = '<span style="color: red;">Ошибка загрузки прогресса: ' + error.message + '</span>';
                document.getElementById('file-list').innerHTML = '';
            } finally {
                button.disabled = false;
                button.textContent = 'Обновить прогресс';
            }
        }
        
        // Загружаем прогресс при загрузке страницы
        document.addEventListener('DOMContentLoaded', function() {
            getConversionProgress();
            // Обновляем прогресс каждые 30 секунд
            setInterval(getConversionProgress, 30000);
        });
        
        async function deleteCollection(collectionName) {
            if (!confirm(`Вы уверены, что хотите удалить коллекцию "${collectionName}"? Это действие необратимо.`)) {
                return;
            }
            
            const deleteBtn = event.target;
            const collectionItem = deleteBtn.parentElement;
            const originalText = deleteBtn.textContent;
            
            deleteBtn.disabled = true;
            deleteBtn.textContent = 'Удаление...';
            
            try {
                const response = await fetch('/api/indexing/delete-collection', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ collection_name: collectionName })
                });
                
                const data = await response.json();
                
                if (data.status === 'deleted') {
                    collectionItem.remove();
                    // Показываем сообщение об успешном удалении
                    const statusDiv = document.createElement('div');
                    statusDiv.className = 'status-message status-success';
                    statusDiv.textContent = `Коллекция "${collectionName}" успешно удалена`;
                    document.querySelector('main').insertBefore(statusDiv, document.querySelector('.controls-section'));
                    
                    setTimeout(() => {
                        statusDiv.remove();
                    }, 5000);
                } else {
                    alert('Ошибка при удалении коллекции: ' + (data.message || 'Неизвестная ошибка'));
                    deleteBtn.disabled = false;
                    deleteBtn.textContent = originalText;
                }
            } catch (error) {
                alert('Ошибка подключения при удалении коллекции: ' + error.message);
                deleteBtn.disabled = false;
                deleteBtn.textContent = originalText;
            }
        }
        
        // Обработчик формы обновления путей
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.getElementById('update-paths-form');
            if (form) {
                form.addEventListener('submit', async function(e) {
                    e.preventDefault(); // Предотвращаем стандартную отправку формы
                    
                    const statusDiv = document.getElementById('paths-status');
                    const submitBtn = form.querySelector('button[type="submit"]');
                    
                    // Получаем значения из формы
                    const formData = new FormData(form);
                    
                    submitBtn.disabled = true;
                    submitBtn.textContent = 'Обновление...';
                    statusDiv.textContent = 'Отправка запроса на обновление путей...';
                    
                    try {
                        const response = await fetch('/api/indexing/update-paths', {
                            method: 'POST',
                            body: formData
                        });
                        
                        const data = await response.json();
                        
                        if (data.status === 'success') {
                            statusDiv.innerHTML = '<span style="color: green;">✓</span> ' + data.message;
                            // Обновляем значения в полях формы
                            document.getElementById('indexing_folder').value = data.paths.indexing_folder;
                            document.getElementById('input_pdf_dir').value = data.paths.input_pdf_dir;
                            document.getElementById('output_md_dir').value = data.paths.output_md_dir;
                        } else {
                            statusDiv.innerHTML = '<span style="color: red;">✗ Ошибка:</span> ' + data.message;
                        }
                    } catch (error) {
                        statusDiv.innerHTML = '<span style="color: red;">✗ Ошибка подключения:</span> ' + error.message;
                    } finally {
                        submitBtn.disabled = false;
                        submitBtn.textContent = 'Обновить пути';
                    }
                });
            }
        });
    </script>
</body>
</html>