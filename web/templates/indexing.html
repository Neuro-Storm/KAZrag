<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–ò–Ω–¥–µ–∫—Å–∞—Ü–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤</title>
    <link rel="stylesheet" href="/static/simple.min.css">
    <style>
        .status-message {
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 4px;
        }
        .status-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status-error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status-info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .controls-section {
            margin: 1rem 0;
            padding: 1rem;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .collection-list {
            margin: 1rem 0;
        }
        .collection-item {
            padding: 0.5rem;
            margin: 0.25rem 0;
            border: 1px solid #eee;
            border-radius: 3px;
            background-color: #f9f9f9;
        }
    </style>
</head>
<body>
    <header>
        <h1>–ò–Ω–¥–µ–∫—Å–∞—Ü–∏—è –∏ –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤</h1>
        <nav>
            <a href="/api/admin/settings/">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</a> |
            <a href="/api/indexing/">–ò–Ω–¥–µ–∫—Å–∞—Ü–∏—è</a> |
            <a href="/api/search/">–ü–æ–∏—Å–∫</a>
        </nav>
    </header>
    
    <main>
        {% if status_message %}
            <div class="status-message status-{{ status_type }}">
                {{ status_message }}
            </div>
        {% endif %}
        
        {% if error %}
            <div class="status-message status-error">
                {{ error }}
            </div>
        {% endif %}
        
        <div class="controls-section">
            <h2>–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏</h2>
            <form id="update-paths-form" method="post" action="/api/indexing/update-paths">
                <p><strong>–ü–∞–ø–∫–∞ –¥–ª—è –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏:</strong></p>
                <input type="text" name="indexing_folder" id="indexing_folder" value="{{ config.folder_path }}" style="width: 100%; padding: 0.5rem; margin: 0.25rem 0;"/>
                
                <p><strong>–í—Ö–æ–¥–Ω–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –¥–ª—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏:</strong></p>
                <input type="text" name="input_pdf_dir" id="input_pdf_dir" value="{{ config.mineru_input_pdf_dir }}" style="width: 100%; padding: 0.5rem; margin: 0.25rem 0;"/>
                
                <p><strong>–í—ã—Ö–æ–¥–Ω–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è MD:</strong></p>
                <input type="text" name="output_md_dir" id="output_md_dir" value="{{ config.mineru_output_md_dir }}" style="width: 100%; padding: 0.5rem; margin: 0.25rem 0;"/>
                
                <button type="submit">–û–±–Ω–æ–≤–∏—Ç—å –ø—É—Ç–∏</button>
            </form>
            <div id="paths-status" style="margin-top: 1rem;"></div>
            
            <p><strong>–ò–º—è –∫–æ–ª–ª–µ–∫—Ü–∏–∏:</strong> {{ config.collection_name }}</p>
            <p><strong>–ú–æ–¥–µ–ª—å —ç–º–±–µ–¥–¥–∏–Ω–≥–æ–≤:</strong> {{ config.current_hf_model }}</p>
            <p><strong>–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ:</strong> {{ config.device }}</p>
        </div>
        
        <div class="controls-section">
            <h2>–ó–∞–ø—É—Å–∫ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤</h2>
            
            <div>
                <h3>–ò–Ω–¥–µ–∫—Å–∞—Ü–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤</h3>
                <p><strong>–î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏:</strong> {{ config.folder_path }}</p>
                <button id="run-indexing-btn" onclick="runIndexing()">–ó–∞–ø—É—Å—Ç–∏—Ç—å –∏–Ω–¥–µ–∫—Å–∞—Ü–∏—é</button>
                <button id="stop-indexing-btn" onclick="stopIndexing()" style="margin-left: 10px; background-color: #dc3545; color: white;">–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏–Ω–¥–µ–∫—Å–∞—Ü–∏—é</button>
                <button id="refresh-indexing-progress-btn" onclick="getIndexingProgress()" style="margin-left: 10px;">–û–±–Ω–æ–≤–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å</button>
                <div id="indexing-status" style="margin-top: 1rem;"></div>

                <div id="indexing-progress" style="margin-top: 1rem; padding: 1rem; border: 1px solid #ddd; background-color: #f9f9f9;">
                    <h4>–ü—Ä–æ–≥—Ä–µ—Å—Å –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏</h4>
                    <div id="indexing-progress-summary">
                        <p>–ó–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –ø—Ä–æ–≥—Ä–µ—Å—Å...</p>
                    </div>
                    <div style="margin: 0.5rem 0; display: flex; gap: 10px; align-items: center;">
                        <label for="indexing-file-status-filter">–§–∏–ª—å—Ç—Ä: </label>
                        <select id="indexing-file-status-filter" onchange="filterAndDisplayIndexingFiles()" style="padding: 0.25rem;">
                            <option value="">–í—Å–µ —Ñ–∞–π–ª—ã</option>
                            <option value="indexed">–ü—Ä–æ–∏–Ω–¥–µ–∫—Å–∏—Ä–æ–≤–∞–Ω–æ</option>
                            <option value="error">–û—à–∏–±–∫–∏</option>
                            <option value="loading">–ó–∞–≥—Ä—É–∑–∫–∞</option>
                            <option value="chunking">–†–∞–∑–¥–µ–ª–µ–Ω–∏–µ</option>
                            <option value="chunked">–†–∞–∑–±–∏—Ç–æ –Ω–∞ —á–∞–Ω–∫–∏</option>
                            <option value="indexing">–ò–Ω–¥–µ–∫—Å–∞—Ü–∏—è</option>
                            <option value="multilevel_indexing">–ú–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤–∞—è –∏–Ω–¥–µ–∫—Å–∞—Ü–∏—è</option>
                            <option value="processing">–í –ø—Ä–æ—Ü–µ—Å—Å–µ</option>
                            <option value="pending">–û–∂–∏–¥–∞–µ—Ç</option>
                        </select>
                        <label for="indexing-files-display-limit">–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å: </label>
                        <input type="number" id="indexing-files-display-limit" value="50" min="1" max="500" style="width: 70px; padding: 0.25rem;" onchange="filterAndDisplayIndexingFiles()" title="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ñ–∞–π–ª–æ–≤ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è">
                        <span>—Ñ–∞–π–ª–æ–≤</span>
                    </div>
                    <div id="indexing-file-list" style="margin-top: 1rem; max-height: 300px; overflow-y: auto;">
                        <!-- –°–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤ –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω –∑–¥–µ—Å—å -->
                    </div>
                </div>
            </div>
            
            <hr style="margin: 1rem 0;">
            
            <div>
                <h3>–ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è —Ñ–∞–π–ª–æ–≤</h3>
                <p><strong>–í—Ö–æ–¥–Ω–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è:</strong> {{ config.mineru_input_pdf_dir }}</p>
                <p><strong>–í—ã—Ö–æ–¥–Ω–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è:</strong> {{ config.mineru_output_md_dir }}</p>
                <button id="process-files-btn" onclick="processFiles()">–ó–∞–ø—É—Å—Ç–∏—Ç—å –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—é</button>
                <button id="stop-conversion-btn" onclick="stopConversion()" style="margin-left: 10px; background-color: #dc3545; color: white;">–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—é</button>
                <button id="refresh-progress-btn" onclick="getConversionProgress()" style="margin-left: 10px;">–û–±–Ω–æ–≤–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å</button>
                <div id="conversion-status" style="margin-top: 1rem;"></div>
                
                <div id="conversion-progress" style="margin-top: 1rem; padding: 1rem; border: 1px solid #ddd; background-color: #f9f9f9;">
                    <h4>–ü—Ä–æ–≥—Ä–µ—Å—Å –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏</h4>
                    <div id="progress-summary">
                        <p>–ó–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –ø—Ä–æ–≥—Ä–µ—Å—Å...</p>
                    </div>
                    <div style="margin: 0.5rem 0; display: flex; gap: 10px; align-items: center;">
                        <label for="file-status-filter">–§–∏–ª—å—Ç—Ä: </label>
                        <select id="file-status-filter" onchange="filterAndDisplayFiles()" style="padding: 0.25rem;">
                            <option value="">–í—Å–µ —Ñ–∞–π–ª—ã</option>
                            <option value="converted">–û–±—Ä–∞–±–æ—Ç–∞–Ω–æ</option>
                            <option value="error">–û—à–∏–±–∫–∏</option>
                            <option value="in_progress">–í –ø—Ä–æ—Ü–µ—Å—Å–µ</option>
                            <option value="pending">–û–∂–∏–¥–∞–µ—Ç</option>
                        </select>
                        <label for="files-display-limit">–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å: </label>
                        <input type="number" id="files-display-limit" value="50" min="1" max="500" style="width: 70px; padding: 0.25rem;" onchange="filterAndDisplayFiles()" title="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ñ–∞–π–ª–æ–≤ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è">
                        <span>—Ñ–∞–π–ª–æ–≤</span>
                    </div>
                    <div id="file-list" style="margin-top: 1rem; max-height: 300px; overflow-y: auto;">
                        <!-- –°–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤ –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω –∑–¥–µ—Å—å -->
                    </div>
                </div>
            </div>
        </div>
        
        <div class="controls-section">
            <h2>–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–ª–ª–µ–∫—Ü–∏–∏</h2>
            {% if collections %}
                <ul class="collection-list">
                    {% for collection in collections %}
                        <li class="collection-item">
                            <span>{{ collection.name }} (–≤–µ–∫—Ç–æ—Ä–æ–≤: {{ collection.points_count }})</span>
                            <button class="delete-collection-btn" onclick="deleteCollection('{{ collection.name }}')" style="float: right; margin-left: 10px;">–£–¥–∞–ª–∏—Ç—å</button>
                        </li>
                    {% endfor %}
                </ul>
            {% else %}
                <p>–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫–æ–ª–ª–µ–∫—Ü–∏–π</p>
            {% endif %}
        </div>
    </main>
    
    <script>
        async function runIndexing() {
            const button = document.getElementById('run-indexing-btn');
            const statusDiv = document.getElementById('indexing-status');

            button.disabled = true;
            button.textContent = '–ó–∞–ø—É—Å–∫...';
            statusDiv.textContent = '–û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ –∏–Ω–¥–µ–∫—Å–∞—Ü–∏—é...';

            try {
                const response = await fetch('/api/indexing/run-indexing', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                const data = await response.json();

                if (data.status === 'indexing_started') {
                    statusDiv.innerHTML = '<span style="color: green;">‚úì</span> ' + data.message;
                    // –ù–∞—á–∏–Ω–∞–µ–º –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å –ø–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞ —Å –Ω–µ–±–æ–ª—å—à–æ–π –∑–∞–¥–µ—Ä–∂–∫–æ–π
                    setTimeout(() => getIndexingProgress(), 2000);
                } else {
                    statusDiv.innerHTML = '<span style="color: red;">‚úó –û—à–∏–±–∫–∞:</span> ' + data.message;
                }
            } catch (error) {
                statusDiv.innerHTML = '<span style="color: red;">‚úó –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è:</span> ' + error.message;
            } finally {
                button.disabled = false;
                button.textContent = '–ó–∞–ø—É—Å—Ç–∏—Ç—å –∏–Ω–¥–µ–∫—Å–∞—Ü–∏—é';
            }
        }

        async function stopIndexing() {
            const button = document.getElementById('stop-indexing-btn');
            const statusDiv = document.getElementById('indexing-status');

            button.disabled = true;
            button.textContent = '–û—Å—Ç–∞–Ω–æ–≤–∫–∞...';
            statusDiv.textContent = '–û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫—É –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏...';

            try {
                const response = await fetch('/api/indexing/stop-indexing', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                const data = await response.json();

                if (data.status === 'stopped') {
                    statusDiv.innerHTML = '<span style="color: green;">‚úì</span> ' + data.message;
                    // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –ø–æ—Å–ª–µ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏
                    setTimeout(() => getIndexingProgress(), 1000);
                } else {
                    statusDiv.innerHTML = '<span style="color: red;">‚úó –û—à–∏–±–∫–∞:</span> ' + data.message;
                }
            } catch (error) {
                statusDiv.innerHTML = '<span style="color: red;">‚úó –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è:</span> ' + error.message;
            } finally {
                button.disabled = false;
                button.textContent = '–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏–Ω–¥–µ–∫—Å–∞—Ü–∏—é';
            }
        }

        async function getIndexingProgress() {
            const progressDiv = document.getElementById('indexing-progress-summary');
            const fileListDiv = document.getElementById('indexing-file-list');
            const button = document.getElementById('refresh-indexing-progress-btn');

            button.disabled = true;
            button.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞...';

            try {
                const response = await fetch('/api/indexing/indexing-progress?t=' + Date.now(), {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                // Store the data globally so we can filter it
                window.indexingData = await response.json();
                const data = window.indexingData;

                if (data.status === 'error') {
                    progressDiv.innerHTML = '<span style="color: red;">–û—à–∏–±–∫–∞: ' + data.message + '</span>';
                    fileListDiv.innerHTML = '';
                    return;
                }

                // –û–±–Ω–æ–≤–ª—è–µ–º —Å–≤–æ–¥–∫—É –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
                let sessionInfo = '';
                let currentFileInfo = '';
                let collectionInfo = '';
                if (data.session_id) {
                    const statusText = {
                        'running': '–í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è',
                        'completed': '–ó–∞–≤–µ—Ä—à–µ–Ω–æ',
                        'stopped': '–û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ',
                        'error': '–û—à–∏–±–∫–∞',
                        'no_session': '–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–π —Å–µ—Å—Å–∏–∏'
                    };
                    sessionInfo = `<p><strong>–°–µ—Å—Å–∏—è:</strong> ${data.session_id} | <strong>–°—Ç–∞—Ç—É—Å:</strong> ${statusText[data.status] || data.status}</p>`;

                    // –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–æ–ª–ª–µ–∫—Ü–∏–∏
                    if (data.collection_name) {
                        collectionInfo = `<p><strong>–ö–æ–ª–ª–µ–∫—Ü–∏—è:</strong> ${data.collection_name}</p>`;
                    }

                    // –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–µ–∫—É—â–µ–º —Ñ–∞–π–ª–µ –∏ —ç—Ç–∞–ø–µ
                    if (data.current_file && data.status === 'running') {
                        const stageText = {
                            'loading': 'üìÇ –ó–∞–≥—Ä—É–∑–∫–∞',
                            'chunking': '‚úÇÔ∏è –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –Ω–∞ —á–∞–Ω–∫–∏',
                            'chunked': 'üß© –ì–æ—Ç–æ–≤–æ –∫ –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏',
                            'indexing': 'üìù –ò–Ω–¥–µ–∫—Å–∞—Ü–∏—è –≤ Qdrant',
                            'multilevel_indexing': 'üîó –ú–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤–∞—è –∏–Ω–¥–µ–∫—Å–∞—Ü–∏—è'
                        };
                        const stageEmoji = stageText[data.current_stage] || '‚è≥';
                        currentFileInfo = `<p style="color: #007bff; font-weight: bold;"><strong>–¢–µ–∫—É—â–∏–π —Ñ–∞–π–ª:</strong> ${stageEmoji} ${data.current_file}</p>`;
                    }
                }

                progressDiv.innerHTML = `
                    ${sessionInfo}
                    ${collectionInfo}
                    ${currentFileInfo}
                    <p><strong>–í—Å–µ–≥–æ —Ñ–∞–π–ª–æ–≤:</strong> ${data.total_files}</p>
                    <p><strong>–ü—Ä–æ–∏–Ω–¥–µ–∫—Å–∏—Ä–æ–≤–∞–Ω–æ:</strong> ${data.indexed_files} | <strong>–û—à–∏–±–∫–∏:</strong> ${data.error_files} | <strong>–í –ø—Ä–æ—Ü–µ—Å—Å–µ:</strong> ${data.processed_files - data.indexed_files - data.error_files} | <strong>–û–∂–∏–¥–∞–µ—Ç:</strong> ${data.pending_files}</p>
                    <div style="height: 20px; background-color: #eee; border-radius: 10px; overflow: hidden;">
                        <div style="height: 100%; width: ${data.total_files > 0 ? (data.indexed_files / data.total_files * 100) : 0}%; background-color: #28a745; float: left;"></div>
                        <div style="height: 100%; width: ${data.total_files > 0 ? (data.error_files / data.total_files * 100) : 0}%; background-color: #dc3545; float: left;"></div>
                        <div style="height: 100%; width: ${data.total_files > 0 ? ((data.processed_files - data.indexed_files - data.error_files) / data.total_files * 100) : 0}%; background-color: #ffc107; float: left;"></div>
                    </div>
                `;

                // –¢–µ–ø–µ—Ä—å –ø—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—é –∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
                filterAndDisplayIndexingFiles();
            } catch (error) {
                console.error('Error loading indexing progress:', error);
                progressDiv.innerHTML = '<span style="color: red;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞: ' + error.message + '</span>';
                fileListDiv.innerHTML = '<p style="color: red;">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤</p>';
            } finally {
                button.disabled = false;
                button.textContent = '–û–±–Ω–æ–≤–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å';
            }
        }

        // Function to filter and display indexing files based on current filter settings
        function filterAndDisplayIndexingFiles() {
            const fileListDiv = document.getElementById('indexing-file-list');
            const statusFilter = document.getElementById('indexing-file-status-filter').value;
            const displayLimit = parseInt(document.getElementById('indexing-files-display-limit').value) || 50;

            // We need to make sure we have the indexingData variable defined
            if (window.indexingData && window.indexingData.files && Object.keys(window.indexingData.files).length > 0) {
                fileListDiv.innerHTML = '<h5>–§–∞–π–ª—ã:</h5><ul style="list-style-type: none; padding: 0;">';

                let filteredFiles = Object.entries(window.indexingData.files);

                // Apply status filter if specified
                if (statusFilter && statusFilter !== '') {
                    filteredFiles = filteredFiles.filter(([filePath, fileInfo]) => {
                        return fileInfo && fileInfo.status === statusFilter;
                    });
                }

                // Apply display limit
                if (displayLimit > 0) {
                    filteredFiles = filteredFiles.slice(0, displayLimit);
                }

                for (const [filePath, fileInfo] of filteredFiles) {
                    // Skip if fileInfo is undefined or null
                    if (!fileInfo) {
                        continue;
                    }

                    let statusClass = '';
                    let statusIcon = '';
                    const status = fileInfo.status || 'unknown';

                    if (status === 'indexed') {
                        statusClass = 'style="color: green;"';
                        statusIcon = '‚úì ';
                    } else if (status === 'error') {
                        statusClass = 'style="color: red;"';
                        statusIcon = '‚úó ';
                    } else if (status === 'loading') {
                        statusClass = 'style="color: blue;"';
                        statusIcon = 'üìÇ ';
                    } else if (status === 'chunking') {
                        statusClass = 'style="color: purple;"';
                        statusIcon = '‚úÇÔ∏è ';
                    } else if (status === 'chunked') {
                        statusClass = 'style="color: cyan;"';
                        statusIcon = 'üß© ';
                    } else if (status === 'indexing') {
                        statusClass = 'style="color: orange;"';
                        statusIcon = 'üìù ';
                    } else if (status === 'multilevel_indexing') {
                        statusClass = 'style="color: darkorange;"';
                        statusIcon = 'üîó ';
                    } else if (status === 'processing') {
                        statusClass = 'style="color: orange;"';
                        statusIcon = '‚è≥ ';
                    } else if (status === 'pending') {
                        statusClass = 'style="color: gray;"';
                        statusIcon = '‚óã ';
                    } else {
                        statusClass = 'style="color: gray;"';
                        statusIcon = '‚óã ';
                    }

                    // –ö—Ä–æ—Å—Å–ø–ª–∞—Ç—Ñ–æ—Ä–º–µ–Ω–Ω–æ–µ –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞ (–ø–æ–¥–¥–µ—Ä–∂–∫–∞ Windows –∏ Linux)
                    const fileName = filePath.split(/[/\\]+/).pop();
                    let errorMsg = '';
                    if (fileInfo.error_message) {
                        errorMsg = `<br><small style="color: red;">–û—à–∏–±–∫–∞: ${fileInfo.error_message}</small>`;
                    }

                    fileListDiv.innerHTML += `<li ${statusClass}>${statusIcon}${fileName} (${status})${errorMsg}</li>`;
                }

                if (filteredFiles.length === 0) {
                    fileListDiv.innerHTML += '<li>–ù–µ—Ç —Ñ–∞–π–ª–æ–≤ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å –≤—ã–±—Ä–∞–Ω–Ω—ã–º —Ñ–∏–ª—å—Ç—Ä–æ–º</li>';
                }

                fileListDiv.innerHTML += '</ul>';
            } else {
                // No files data available or no active session
                if (!window.indexingData) {
                    fileListDiv.innerHTML = '<p>–î–∞–Ω–Ω—ã–µ –æ –ø—Ä–æ–≥—Ä–µ—Å—Å–µ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã</p>';
                } else if (!window.indexingData.files || Object.keys(window.indexingData.files).length === 0) {
                    if (window.indexingData.session_id) {
                        fileListDiv.innerHTML = `<p>–ù–µ—Ç —Ñ–∞–π–ª–æ–≤ –≤ —Ç–µ–∫—É—â–µ–π —Å–µ—Å—Å–∏–∏ (${window.indexingData.session_id})</p>`;
                    } else {
                        fileListDiv.innerHTML = '<p>–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–π —Å–µ—Å—Å–∏–∏ –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏</p>';
                    }
                } else {
                    // Display files from no_session state (files from directory)
                    fileListDiv.innerHTML = '<h5>–§–∞–π–ª—ã –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏:</h5><ul style="list-style-type: none; padding: 0;">';

                    let filteredFiles = Object.entries(window.indexingData.files);

                    // Apply status filter if specified
                    if (statusFilter && statusFilter !== '') {
                        filteredFiles = filteredFiles.filter(([filePath, fileInfo]) => {
                            return fileInfo && fileInfo.status === statusFilter;
                        });
                    }

                    // Apply display limit
                    if (displayLimit > 0) {
                        filteredFiles = filteredFiles.slice(0, displayLimit);
                    }

                    for (const [filePath, fileInfo] of filteredFiles) {
                        // Skip if fileInfo is undefined or null
                        if (!fileInfo) {
                            continue;
                        }

                        let statusClass = '';
                        let statusIcon = '';
                        const status = fileInfo.status || 'unknown';

                        if (status === 'indexed') {
                            statusClass = 'style="color: green;"';
                            statusIcon = '‚úì ';
                        } else if (status === 'error') {
                            statusClass = 'style="color: red;"';
                            statusIcon = '‚úó ';
                        } else if (status === 'loading') {
                            statusClass = 'style="color: blue;"';
                            statusIcon = 'üìÇ ';
                        } else if (status === 'chunking') {
                            statusClass = 'style="color: purple;"';
                            statusIcon = '‚úÇÔ∏è ';
                        } else if (status === 'chunked') {
                            statusClass = 'style="color: cyan;"';
                            statusIcon = 'üß© ';
                        } else if (status === 'indexing') {
                            statusClass = 'style="color: orange;"';
                            statusIcon = 'üìù ';
                        } else if (status === 'multilevel_indexing') {
                            statusClass = 'style="color: darkorange;"';
                            statusIcon = 'üîó ';
                        } else if (status === 'processing') {
                            statusClass = 'style="color: orange;"';
                            statusIcon = '‚è≥ ';
                        } else if (status === 'pending') {
                            statusClass = 'style="color: gray;"';
                            statusIcon = '‚óã ';
                        } else {
                            statusClass = 'style="color: gray;"';
                            statusIcon = '‚óã ';
                        }

                        // –ö—Ä–æ—Å—Å–ø–ª–∞—Ç—Ñ–æ—Ä–º–µ–Ω–Ω–æ–µ –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞ (–ø–æ–¥–¥–µ—Ä–∂–∫–∞ Windows –∏ Linux)
                    const fileName = filePath.split(/[/\\]+/).pop();
                        let errorMsg = '';
                        if (fileInfo.error_message) {
                            errorMsg = `<br><small style="color: red;">–û—à–∏–±–∫–∞: ${fileInfo.error_message}</small>`;
                        }

                        fileListDiv.innerHTML += `<li ${statusClass}>${statusIcon}${fileName} (${status})${errorMsg}</li>`;
                    }

                    if (filteredFiles.length === 0) {
                        fileListDiv.innerHTML += '<li>–ù–µ—Ç —Ñ–∞–π–ª–æ–≤ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å –≤—ã–±—Ä–∞–Ω–Ω—ã–º —Ñ–∏–ª—å—Ç—Ä–æ–º</li>';
                    }

                    fileListDiv.innerHTML += '</ul>';
                }
            }
        }

        async function processFiles() {
            const button = document.getElementById('process-files-btn');
            const statusDiv = document.getElementById('conversion-status');
            
            button.disabled = true;
            button.textContent = '–ó–∞–ø—É—Å–∫...';
            statusDiv.textContent = '–û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—é...';
            
            try {
                const response = await fetch('/api/indexing/process-files', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                const data = await response.json();
                
                if (data.status === 'processing_started') {
                    statusDiv.innerHTML = '<span style="color: green;">‚úì</span> ' + data.message;
                } else {
                    statusDiv.innerHTML = '<span style="color: red;">‚úó –û—à–∏–±–∫–∞:</span> ' + data.message;
                }
            } catch (error) {
                statusDiv.innerHTML = '<span style="color: red;">‚úó –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è:</span> ' + error.message;
            } finally {
                button.disabled = false;
                button.textContent = '–ó–∞–ø—É—Å—Ç–∏—Ç—å –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—é';
            }
        }
        
        async function stopConversion() {
            const button = document.getElementById('stop-conversion-btn');
            const statusDiv = document.getElementById('conversion-status');
            
            if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–æ—Ü–µ—Å—Å –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏?')) {
                return;
            }
            
            button.disabled = true;
            button.textContent = '–û—Å—Ç–∞–Ω–æ–≤–∫–∞...';
            statusDiv.textContent = '–û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫—É –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏...';
            
            try {
                const response = await fetch('/api/indexing/stop-conversion', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                const data = await response.json();
                
                if (data.status === 'stopped') {
                    statusDiv.innerHTML = '<span style="color: green;">‚úì</span> ' + data.message;
                } else {
                    statusDiv.innerHTML = '<span style="color: red;">‚úó –û—à–∏–±–∫–∞:</span> ' + data.message;
                }
            } catch (error) {
                statusDiv.innerHTML = '<span style="color: red;">‚úó –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è:</span> ' + error.message;
            } finally {
                button.disabled = false;
                button.textContent = '–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—é';
            }
        }
        
        async function getConversionProgress() {
            const progressDiv = document.getElementById('progress-summary');
            const fileListDiv = document.getElementById('file-list');
            const button = document.getElementById('refresh-progress-btn');
            const statusFilter = document.getElementById('file-status-filter').value;
            const displayLimit = parseInt(document.getElementById('files-display-limit').value) || 50;
            
            button.disabled = true;
            button.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞...';
            
            try {
                const response = await fetch('/api/indexing/progress', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                const data = await response.json();
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å–≤–æ–¥–∫—É –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
                progressDiv.innerHTML = `
                    <p><strong>–í—Å–µ–≥–æ —Ñ–∞–π–ª–æ–≤:</strong> ${data.total}</p>
                    <p><strong>–û–±—Ä–∞–±–æ—Ç–∞–Ω–æ:</strong> ${data.converted} | <strong>–û—à–∏–±–∫–∏:</strong> ${data.errors} | <strong>–í –ø—Ä–æ—Ü–µ—Å—Å–µ:</strong> ${data.in_progress} | <strong>–û–∂–∏–¥–∞–µ—Ç:</strong> ${data.pending}</p>
                    <div style="height: 20px; background-color: #eee; border-radius: 10px; overflow: hidden;">
                        <div style="height: 100%; width: ${data.total > 0 ? (data.converted / data.total * 100) : 0}%; background-color: #28a745; float: left;"></div>
                        <div style="height: 100%; width: ${data.total > 0 ? (data.errors / data.total * 100) : 0}%; background-color: #dc3545; float: left;"></div>
                        <div style="height: 100%; width: ${data.total > 0 ? (data.in_progress / data.total * 100) : 0}%; background-color: #ffc107; float: left;"></div>
                    </div>
                `;
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤
                if (Object.keys(data.files).length > 0) {
                    fileListDiv.innerHTML = '<h5>–§–∞–π–ª—ã:</h5><ul style="list-style-type: none; padding: 0;">';
                    for (const [filePath, fileInfo] of Object.entries(data.files)) {
                        let statusClass = '';
                        let statusIcon = '';
                        if (fileInfo.status === 'converted') {
                            statusClass = 'style="color: green;"';
                            statusIcon = '‚úì ';
                        } else if (fileInfo.status === 'error') {
                            statusClass = 'style="color: red;"';
                            statusIcon = '‚úó ';
                        } else if (fileInfo.status === 'in_progress') {
                            statusClass = 'style="color: orange;"';
                            statusIcon = '‚è≥ ';
                        } else {
                            statusClass = 'style="color: gray;"';
                            statusIcon = '‚óã ';
                        }
                        
                        // –ö—Ä–æ—Å—Å–ø–ª–∞—Ç—Ñ–æ—Ä–º–µ–Ω–Ω–æ–µ –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞ (–ø–æ–¥–¥–µ—Ä–∂–∫–∞ Windows –∏ Linux)
                        const fileName = filePath.split(/[/\\]+/).pop();
                        fileListDiv.innerHTML += `<li ${statusClass}>${statusIcon}${fileName} (${fileInfo.status})</li>`;
                    }
                    fileListDiv.innerHTML += '</ul>';
                } else {
                    fileListDiv.innerHTML = '<p>–ù–µ—Ç –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º—ã—Ö —Ñ–∞–π–ª–æ–≤</p>';
                }
            } catch (error) {
                progressDiv.innerHTML = '<span style="color: red;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞: ' + error.message + '</span>';
                fileListDiv.innerHTML = '';
            } finally {
                button.disabled = false;
                button.textContent = '–û–±–Ω–æ–≤–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å';
            }
        }
        
        // Function to filter and display files based on current filter settings
        function filterAndDisplayFiles() {
            const fileListDiv = document.getElementById('file-list');
            const statusFilter = document.getElementById('file-status-filter').value;
            const displayLimit = parseInt(document.getElementById('files-display-limit').value) || 50;
            
            // We need to make sure we have the conversionData variable defined
            if (window.conversionData && Object.keys(window.conversionData.files).length > 0) {
                fileListDiv.innerHTML = '<h5>–§–∞–π–ª—ã:</h5><ul style="list-style-type: none; padding: 0;">';
                
                let filteredFiles = Object.entries(window.conversionData.files);
                
                // Apply status filter if specified
                if (statusFilter) {
                    filteredFiles = filteredFiles.filter(([filePath, fileInfo]) => fileInfo.status === statusFilter);
                }
                
                // Apply display limit
                if (displayLimit > 0) {
                    filteredFiles = filteredFiles.slice(0, displayLimit);
                }
                
                for (const [filePath, fileInfo] of filteredFiles) {
                    let statusClass = '';
                    let statusIcon = '';
                    if (fileInfo.status === 'converted') {
                        statusClass = 'style="color: green;"';
                        statusIcon = '‚úì ';
                    } else if (fileInfo.status === 'error') {
                        statusClass = 'style="color: red;"';
                        statusIcon = '‚úó ';
                    } else if (fileInfo.status === 'in_progress') {
                        statusClass = 'style="color: orange;"';
                        statusIcon = '‚è≥ ';
                    } else {
                        statusClass = 'style="color: gray;"';
                        statusIcon = '‚óã ';
                    }
                    
                    // –ö—Ä–æ—Å—Å–ø–ª–∞—Ç—Ñ–æ—Ä–º–µ–Ω–Ω–æ–µ –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞ (–ø–æ–¥–¥–µ—Ä–∂–∫–∞ Windows –∏ Linux)
                    const fileName = filePath.split(/[/\\]+/).pop();
                    fileListDiv.innerHTML += `<li ${statusClass}>${statusIcon}${fileName} (${fileInfo.status})</li>`;
                }
                
                if (filteredFiles.length === 0) {
                    fileListDiv.innerHTML += '<li>–ù–µ—Ç —Ñ–∞–π–ª–æ–≤ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å –≤—ã–±—Ä–∞–Ω–Ω—ã–º —Ñ–∏–ª—å—Ç—Ä–æ–º</li>';
                }
                
                fileListDiv.innerHTML += '</ul>';
            } else {
                fileListDiv.innerHTML = '<p>–ù–µ—Ç –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º—ã—Ö —Ñ–∞–π–ª–æ–≤</p>';
            }
        }
        
        // Enhanced getConversionProgress that stores data globally
        async function getConversionProgress() {
            const progressDiv = document.getElementById('progress-summary');
            const button = document.getElementById('refresh-progress-btn');
            
            button.disabled = true;
            button.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞...';
            
            try {
                const response = await fetch('/api/indexing/progress', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                // Store the data globally so we can filter it
                window.conversionData = await response.json();
                const data = window.conversionData;
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å–≤–æ–¥–∫—É –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
                progressDiv.innerHTML = `
                    <p><strong>–í—Å–µ–≥–æ —Ñ–∞–π–ª–æ–≤:</strong> ${data.total}</p>
                    <p><strong>–û–±—Ä–∞–±–æ—Ç–∞–Ω–æ:</strong> ${data.converted} | <strong>–û—à–∏–±–∫–∏:</strong> ${data.errors} | <strong>–í –ø—Ä–æ—Ü–µ—Å—Å–µ:</strong> ${data.in_progress} | <strong>–û–∂–∏–¥–∞–µ—Ç:</strong> ${data.pending}</p>
                    <div style="height: 20px; background-color: #eee; border-radius: 10px; overflow: hidden;">
                        <div style="height: 100%; width: ${data.total > 0 ? (data.converted / data.total * 100) : 0}%; background-color: #28a745; float: left;"></div>
                        <div style="height: 100%; width: ${data.total > 0 ? (data.errors / data.total * 100) : 0}%; background-color: #dc3545; float: left;"></div>
                        <div style="height: 100%; width: ${data.total > 0 ? (data.in_progress / data.total * 100) : 0}%; background-color: #ffc107; float: left;"></div>
                    </div>
                `;
                
                // Now apply filtering and display
                filterAndDisplayFiles();
            } catch (error) {
                progressDiv.innerHTML = '<span style="color: red;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞: ' + error.message + '</span>';
                document.getElementById('file-list').innerHTML = '';
            } finally {
                button.disabled = false;
                button.textContent = '–û–±–Ω–æ–≤–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å';
            }
        }
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', function() {
            getConversionProgress();
            getIndexingProgress(); // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏
            // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥ –¥–ª—è –±–æ–ª–µ–µ —á–∞—Å—Ç–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
            setInterval(getConversionProgress, 5000);
            // –£–º–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ - –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ —Ä–µ–∂–µ –∑–∞–ø—Ä–æ—Å—ã
            let lastIndexingStatus = null;
            setInterval(() => {
                getIndexingProgress().then(data => {
                    if (data) {
                        // –ï—Å–ª–∏ —Å—Ç–∞—Ç—É—Å –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏ –∏–∑–º–µ–Ω–∏–ª—Å—è, –æ–±–Ω–æ–≤–ª—è–µ–º —á–∞—â–µ
                        if (data.status !== lastIndexingStatus) {
                            lastIndexingStatus = data.status;
                            if (data.status === 'running') {
                                // –í –Ω–∞—á–∞–ª–µ –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏ –æ–±–Ω–æ–≤–ª—è–µ–º —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã
                                setTimeout(getIndexingProgress, 2000);
                            }
                        }
                        // –í–æ –≤—Ä–µ–º—è –∞–∫—Ç–∏–≤–Ω–æ–π –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏ –æ–±–Ω–æ–≤–ª—è–µ–º –∫–∞–∂–¥—ã–µ 10 —Å–µ–∫—É–Ω–¥
                        if (data.status === 'running') {
                            setTimeout(getIndexingProgress, 10000);
                        }
                    }
                });
            }, 15000); // –ë–∞–∑–æ–≤—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª - –∫–∞–∂–¥—ã–µ 15 —Å–µ–∫—É–Ω–¥ (–∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ —Ä–µ–∂–µ)
        });
        
        async function deleteCollection(collectionName) {
            if (!confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –∫–æ–ª–ª–µ–∫—Ü–∏—é "${collectionName}"? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ.`)) {
                return;
            }
            
            const deleteBtn = event.target;
            const collectionItem = deleteBtn.parentElement;
            const originalText = deleteBtn.textContent;
            
            deleteBtn.disabled = true;
            deleteBtn.textContent = '–£–¥–∞–ª–µ–Ω–∏–µ...';
            
            try {
                const response = await fetch('/api/indexing/delete-collection', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ collection_name: collectionName })
                });
                
                const data = await response.json();
                
                if (data.status === 'deleted') {
                    collectionItem.remove();
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—à–Ω–æ–º —É–¥–∞–ª–µ–Ω–∏–∏
                    const statusDiv = document.createElement('div');
                    statusDiv.className = 'status-message status-success';
                    statusDiv.textContent = `–ö–æ–ª–ª–µ–∫—Ü–∏—è "${collectionName}" —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω–∞`;
                    document.querySelector('main').insertBefore(statusDiv, document.querySelector('.controls-section'));
                    
                    setTimeout(() => {
                        statusDiv.remove();
                    }, 5000);
                } else {
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∫–æ–ª–ª–µ–∫—Ü–∏–∏: ' + (data.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                    deleteBtn.disabled = false;
                    deleteBtn.textContent = originalText;
                }
            } catch (error) {
                alert('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∫–æ–ª–ª–µ–∫—Ü–∏–∏: ' + error.message);
                deleteBtn.disabled = false;
                deleteBtn.textContent = originalText;
            }
        }
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ñ–æ—Ä–º—ã –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—É—Ç–µ–π
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.getElementById('update-paths-form');
            if (form) {
                form.addEventListener('submit', async function(e) {
                    e.preventDefault(); // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É—é –æ—Ç–ø—Ä–∞–≤–∫—É —Ñ–æ—Ä–º—ã
                    
                    const statusDiv = document.getElementById('paths-status');
                    const submitBtn = form.querySelector('button[type="submit"]');
                    
                    // –ü–æ–ª—É—á–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –∏–∑ —Ñ–æ—Ä–º—ã
                    const formData = new FormData(form);
                    
                    submitBtn.disabled = true;
                    submitBtn.textContent = '–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ...';
                    statusDiv.textContent = '–û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—É—Ç–µ–π...';
                    
                    try {
                        const response = await fetch('/api/indexing/update-paths', {
                            method: 'POST',
                            body: formData
                        });
                        
                        const data = await response.json();
                        
                        if (data.status === 'success') {
                            statusDiv.innerHTML = '<span style="color: green;">‚úì</span> ' + data.message;
                            // –û–±–Ω–æ–≤–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –≤ –ø–æ–ª—è—Ö —Ñ–æ—Ä–º—ã
                            document.getElementById('indexing_folder').value = data.paths.indexing_folder;
                            document.getElementById('input_pdf_dir').value = data.paths.input_pdf_dir;
                            document.getElementById('output_md_dir').value = data.paths.output_md_dir;
                        } else {
                            statusDiv.innerHTML = '<span style="color: red;">‚úó –û—à–∏–±–∫–∞:</span> ' + data.message;
                        }
                    } catch (error) {
                        statusDiv.innerHTML = '<span style="color: red;">‚úó –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è:</span> ' + error.message;
                    } finally {
                        submitBtn.disabled = false;
                        submitBtn.textContent = '–û–±–Ω–æ–≤–∏—Ç—å –ø—É—Ç–∏';
                    }
                });
            }
        });
    </script>
</body>
</html>