<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Настройки</title>
    <link rel="stylesheet" href="/static/simple.min.css">
    <style>
        .status-msg { padding: 1rem; margin-bottom: 1rem; border-radius: 4px; }
        .success { background-color: #d4edda; color: #155724; }
        .info { background-color: #cce5ff; color: #004085; }
        .error { background-color: #f8d7da; color: #721c24; }
        fieldset { margin-top: 1rem; }
        legend { font-weight: bold; }
        .grid-2col { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
        .grid-3col { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem; }
        .grid-4col { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 1rem; }
        .form-section { border: 1px solid #ccc; border-radius: 4px; padding: 1rem; margin-bottom: 1rem; }
        .form-section h3 { margin-top: 0; }
        .progress { display: none; padding: 1rem; margin: 1rem 0; background-color: #f0f0f0; border-radius: 4px; }
        .spinner { display: inline-block; width: 20px; height: 20px; border: 3px solid #f3f3f3; border-top: 3px solid #3498db; border-radius: 50%; animation: spin 1s linear infinite; margin-right: 10px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .collapsible { cursor: pointer; padding: 10px; background-color: #f1f1f1; border: none; text-align: left; outline: none; }
        .content { padding: 0 18px; display: none; overflow: hidden; background-color: #f9f9f9; }
        .form-info { background-color: #e9ecef; padding: 1rem; border-radius: 4px; margin-bottom: 1rem; }
        .form-info p { margin: 0 0 0.5rem 0; }
        .form-info ul { margin: 0.5rem 0; padding-left: 1.5rem; }
        .help-text { font-size: 0.9em; color: #6c757d; margin: 0.5rem 0 0 0; }
        #error-message { display: none; color: red; padding: 1rem; background-color: #f8d7da; border: 1px solid #f5c6cb; border-radius: 4px; margin: 1rem 0; }
        #success-message { display: none; color: green; padding: 1rem; background-color: #d4edda; border: 1px solid #c3e6cb; border-radius: 4px; margin: 1rem 0; }
        
        /* New styles for modular settings */
        .module-tabs { display: flex; flex-wrap: wrap; margin-bottom: 1rem; border-bottom: 1px solid #ccc; }
        .module-tab { padding: 1rem; background-color: #f8f9fa; border: 1px solid #ccc; border-bottom: none; cursor: pointer; margin-right: 0.5rem; border-radius: 4px 4px 0 0; }
        .module-tab.active { background-color: #fff; font-weight: bold; }
        .module-tab:hover:not(.active) { background-color: #e9ecef; }
        .module-content { display: none; }
        .module-content.active { display: block; }
        .module-card { border: 1px solid #ccc; border-radius: 4px; padding: 1rem; margin-bottom: 1rem; background-color: #fff; }
        .module-card h3 { margin-top: 0; color: #333; }
    </style>
</head>
<body>
    <header>
        <h1>Настройки и Управление</h1>
        <nav><a href="/">Поиск</a> <a href="/settings/">Настройки</a></nav>
    </header>
    <main>
        {% if status or delete_status %}
            {% set msg = status or delete_status %}
            <div class="status-msg {{ 'success' if 'success' in msg or 'saved' in msg or 'indexed' in msg or 'deleted_' in msg or 'pdfs_processed' in msg or 'files_processed' in msg else 'error' if 'error' in msg or 'fail' in msg or 'no_index_type' in msg or 'delete_error' in msg or 'pdf_processing_error' in msg or 'file_processing_error' in msg else 'info' }}">
                {% if msg == 'saved' %}Настройки сохранены.{% endif %}
                {% if msg == 'indexed_successfully' %}Индексация успешно завершена!{% endif %}
                {% if msg == 'indexed_successfully_no_docs' %}Индексация завершена. Не найдено .txt/.md файлов для обработки.{% endif %}
                {% if 'error' in msg or 'fail' in msg or 'no_index_type' in msg %}Ошибка индексации. Проверьте логи терминала. Сообщение: {{ msg }}{% endif %}
                {% if 'deleted_' in msg and not 'delete_error' in msg %}Коллекция успешно удалена.{% endif %}
                {% if 'delete_error' in msg %}Ошибка при удалении коллекции: {{ msg.split('delete_error_')[-1].replace('_', ' ') }}{% endif %}
                {% if msg == 'error_no_collection_selected' %}Ошибка: Не выбрана коллекция для удаления.{% endif %}
                {% if 'pdfs_processed_successfully' in msg %}PDF файлы успешно обработаны!{% endif %}
                {% if 'pdf_processing_error' in msg %}Ошибка при обработке PDF. Проверьте логи терминала. Сообщение: {{ msg }}{% endif %}
                {% if 'files_processed_successfully' in msg %}Файлы успешно обработаны!{% endif %}
                {% if 'file_processing_error' in msg %}Ошибка при обработке файлов. Проверьте логи терминала. Сообщение: {{ msg }}{% endif %}
                {% if msg == 'indexing_started' %}Индексация запущена в фоновом режиме.{% endif %}
                {% if msg == 'processing_started' %}Обработка запущена в фоновом режиме.{% endif %}
            </div>
        {% endif %}
        
        <!-- Сообщения об ошибках и успехах -->
        <div id="error-message"></div>
        <div id="success-message"></div>
        
        <!-- Module Tabs -->
        <div class="module-tabs">
            <div class="module-tab active" data-module="indexing">Индексация</div>
            <div class="module-tab" data-module="conversion">Конвертация</div>
            <div class="module-tab" data-module="embedding">Эмбеддинг</div>
            <div class="module-tab" data-module="search">Поиск</div>
            <div class="module-tab" data-module="qdrant">Qdrant</div>
            <div class="module-tab" data-module="collections">Коллекции</div>
            <div class="module-tab" data-module="advanced">Продвинутые</div>
        </div>
        
        <!-- Indexing Module -->
        <div id="indexing-module" class="module-content active">
            <div class="module-card">
                <h3>Настройки индексации</h3>
                
                <form action="/api/admin/update-settings" method="post" class="settings-form" data-module="indexing">
                    <input type="hidden" name="action" value="save_index_settings">
                    
                    <label for="folder_path">Папка для индексации (TXT и MD файлы)</label>
                    <input type="text" id="folder_path" name="folder_path" value="{{ config.folder_path }}" required>
                    
                    <label for="collection_name">Имя новой коллекции</label>
                    <input type="text" id="collection_name" name="collection_name" value="{{ config.collection_name }}" required>
                    
                    <div style="margin-top: 1rem;">
                        <input type="checkbox" id="use_multilevel_chunking" name="use_multilevel_chunking" value="True" {% if config.use_multilevel_chunking %}checked{% endif %}>
                        <label for="use_multilevel_chunking">Использовать многоуровневый чанкинг</label>
                    </div>
                    
                    <!-- Обычный чанкинг (когда многоуровневый не используется) -->
                    <div id="standard-chunking-settings" style="margin-top: 1rem; padding: 1rem; border: 1px solid #ccc; border-radius: 4px; {% if config.use_multilevel_chunking %}display: none;{% endif %}">
                        <h4>Настройки обычного чанкинга</h4>
                        
                        <div class="grid-2col">
                            <div>
                                <label for="chunk_size">Размер чанка (символы)</label>
                                <input type="number" id="chunk_size" name="chunk_size" value="{{ config.chunk_size }}" required>
                            </div>
                            <div>
                                <label for="chunk_overlap">Перекрытие чанков (символы)</label>
                                <input type="number" id="chunk_overlap" name="chunk_overlap" value="{{ config.chunk_overlap }}" required>
                            </div>
                        </div>
                        
                        <fieldset style="margin-top: 1rem;">
                            <legend>Стратегия чанкинга</legend>
                            <input type="radio" id="chunking_character" name="chunking_strategy" value="character" {% if config.chunking_strategy == 'character' %}checked{% endif %}>
                            <label for="chunking_character">По символам</label><br>
                            <input type="radio" id="chunking_paragraph" name="chunking_strategy" value="paragraph" {% if config.chunking_strategy == 'paragraph' %}checked{% endif %}>
                            <label for="chunking_paragraph">По абзацам</label><br>
                            <input type="radio" id="chunking_sentence" name="chunking_strategy" value="sentence" {% if config.chunking_strategy == 'sentence' %}checked{% endif %}>
                            <label for="chunking_sentence">По предложениям</label><br>
                            
                            <div id="paragraph-settings" style="margin-top: 1rem; padding: 1rem; border: 1px solid #eee; border-radius: 4px; {% if config.chunking_strategy != 'paragraph' %}display: none;{% endif %}">
                                <div class="grid-2col">
                                    <div>
                                        <label for="paragraphs_per_chunk">Абзацев в чанке</label>
                                        <input type="number" id="paragraphs_per_chunk" name="paragraphs_per_chunk" value="{{ config.paragraphs_per_chunk }}" min="1" required>
                                    </div>
                                    <div>
                                        <label for="paragraph_overlap">Перекрытие абзацев</label>
                                        <input type="number" id="paragraph_overlap" name="paragraph_overlap" value="{{ config.paragraph_overlap }}" min="0" required>
                                    </div>
                                </div>
                            </div>
                            
                            <div id="sentence-settings" style="margin-top: 1rem; padding: 1rem; border: 1px solid #eee; border-radius: 4px; {% if config.chunking_strategy != 'sentence' %}display: none;{% endif %}">
                                <div class="grid-2col">
                                    <div>
                                        <label for="sentences_per_chunk">Предложений в чанке</label>
                                        <input type="number" id="sentences_per_chunk" name="sentences_per_chunk" value="{{ config.sentences_per_chunk }}" min="1" required>
                                    </div>
                                    <div>
                                        <label for="sentence_overlap">Перекрытие предложений</label>
                                        <input type="number" id="sentence_overlap" name="sentence_overlap" value="{{ config.sentence_overlap }}" min="0" required>
                                    </div>
                                </div>
                            </div>
                        </fieldset>
                    </div>
                    
                    <!-- Многоуровневый чанкинг -->
                    <div id="multilevel-chunking-settings" style="margin-top: 1rem; padding: 1rem; border: 1px solid #ccc; border-radius: 4px; {% if not config.use_multilevel_chunking %}display: none;{% endif %}">
                        <h4>Настройки многоуровневого чанкинга</h4>
                        
                        <div style="margin-top: 1rem;">
                            <label for="multilevel_macro_strategy">Стратегия макро-чанкинга (основные чанки):</label>
                            <select id="multilevel_macro_strategy" name="multilevel_macro_strategy">
                                <option value="character" {% if config.multilevel_macro_strategy == 'character' %}selected{% endif %}>По символам</option>
                                <option value="paragraph" {% if config.multilevel_macro_strategy == 'paragraph' %}selected{% endif %}>По абзацам</option>
                                <option value="sentence" {% if config.multilevel_macro_strategy == 'sentence' %}selected{% endif %}>По предложениям</option>
                            </select>
                        </div>
                        
                        <div id="multilevel-macro-character-settings" style="margin-top: 1rem; padding: 1rem; border: 1px solid #eee; border-radius: 4px; {% if config.multilevel_macro_strategy != 'character' %}display: none;{% endif %}">
                            <div class="grid-2col">
                                <div>
                                    <label for="multilevel_macro_chunk_size">Размер макро-чанка (символы)</label>
                                    <input type="number" id="multilevel_macro_chunk_size" name="multilevel_macro_chunk_size" value="{{ config.multilevel_macro_chunk_size }}" min="1000" required>
                                </div>
                                <div>
                                    <label for="multilevel_macro_chunk_overlap">Перекрытие макро-чанков (символы)</label>
                                    <input type="number" id="multilevel_macro_chunk_overlap" name="multilevel_macro_chunk_overlap" value="{{ config.multilevel_macro_chunk_overlap }}" min="0" required>
                                </div>
                            </div>
                        </div>
                        
                        <div id="multilevel-macro-paragraph-settings" style="margin-top: 1rem; padding: 1rem; border: 1px solid #eee; border-radius: 4px; {% if config.multilevel_macro_strategy != 'paragraph' %}display: none;{% endif %}">
                            <div class="grid-2col">
                                <div>
                                    <label for="multilevel_macro_paragraphs_per_chunk">Абзацев в макро-чанке</label>
                                    <input type="number" id="multilevel_macro_paragraphs_per_chunk" name="multilevel_macro_paragraphs_per_chunk" value="{{ config.multilevel_macro_paragraphs_per_chunk }}" min="1" required>
                                </div>
                                <div>
                                    <label for="multilevel_macro_paragraph_overlap">Перекрытие абзацев в макро-чанках</label>
                                    <input type="number" id="multilevel_macro_paragraph_overlap" name="multilevel_macro_paragraph_overlap" value="{{ config.multilevel_macro_paragraph_overlap }}" min="0" required>
                                </div>
                            </div>
                        </div>
                        
                        <div id="multilevel-macro-sentence-settings" style="margin-top: 1rem; padding: 1rem; border: 1px solid #eee; border-radius: 4px; {% if config.multilevel_macro_strategy != 'sentence' %}display: none;{% endif %}">
                            <div class="grid-2col">
                                <div>
                                    <label for="multilevel_macro_sentences_per_chunk">Предложений в макро-чанке</label>
                                    <input type="number" id="multilevel_macro_sentences_per_chunk" name="multilevel_macro_sentences_per_chunk" value="{{ config.multilevel_macro_sentences_per_chunk }}" min="1" required>
                                </div>
                                <div>
                                    <label for="multilevel_macro_sentence_overlap">Перекрытие предложений в макро-чанках</label>
                                    <input type="number" id="multilevel_macro_sentence_overlap" name="multilevel_macro_sentence_overlap" value="{{ config.multilevel_macro_sentence_overlap }}" min="0" required>
                                </div>
                            </div>
                        </div>
                        
                        <div style="margin-top: 1rem;">
                            <label for="multilevel_micro_strategy">Стратегия микро-чанкинга (дополнительные векторы):</label>
                            <select id="multilevel_micro_strategy" name="multilevel_micro_strategy">
                                <option value="character" {% if config.multilevel_micro_strategy == 'character' %}selected{% endif %}>По символам</option>
                                <option value="paragraph" {% if config.multilevel_micro_strategy == 'paragraph' %}selected{% endif %}>По абзацам</option>
                                <option value="sentence" {% if config.multilevel_micro_strategy == 'sentence' %}selected{% endif %}>По предложениям</option>
                            </select>
                        </div>
                        
                        <div id="multilevel-micro-character-settings" style="margin-top: 1rem; padding: 1rem; border: 1px solid #eee; border-radius: 4px; {% if config.multilevel_micro_strategy != 'character' %}display: none;{% endif %}">
                            <div class="grid-2col">
                                <div>
                                    <label for="multilevel_micro_chunk_size">Размер микро-чанка (символы)</label>
                                    <input type="number" id="multilevel_micro_chunk_size" name="multilevel_micro_chunk_size" value="{{ config.multilevel_micro_chunk_size }}" min="100" required>
                                </div>
                                <div>
                                    <label for="multilevel_micro_chunk_overlap">Перекрытие микро-чанков (символы)</label>
                                    <input type="number" id="multilevel_micro_chunk_overlap" name="multilevel_micro_chunk_overlap" value="{{ config.multilevel_micro_chunk_overlap }}" min="0" required>
                                </div>
                            </div>
                        </div>
                        
                        <div id="multilevel-micro-paragraph-settings" style="margin-top: 1rem; padding: 1rem; border: 1px solid #eee; border-radius: 4px; {% if config.multilevel_micro_strategy != 'paragraph' %}display: none;{% endif %}">
                            <div class="grid-2col">
                                <div>
                                    <label for="multilevel_micro_paragraphs_per_chunk">Абзацев в микро-чанке</label>
                                    <input type="number" id="multilevel_micro_paragraphs_per_chunk" name="multilevel_micro_paragraphs_per_chunk" value="{{ config.multilevel_micro_paragraphs_per_chunk }}" min="1" required>
                                </div>
                                <div>
                                    <label for="multilevel_micro_paragraph_overlap">Перекрытие абзацев в микро-чанках</label>
                                    <input type="number" id="multilevel_micro_paragraph_overlap" name="multilevel_micro_paragraph_overlap" value="{{ config.multilevel_micro_paragraph_overlap }}" min="0" required>
                                </div>
                            </div>
                        </div>
                        
                        <div id="multilevel-micro-sentence-settings" style="margin-top: 1rem; padding: 1rem; border: 1px solid #eee; border-radius: 4px; {% if config.multilevel_micro_strategy != 'sentence' %}display: none;{% endif %}">
                            <div class="grid-2col">
                                <div>
                                    <label for="multilevel_micro_sentences_per_chunk">Предложений в микро-чанке</label>
                                    <input type="number" id="multilevel_micro_sentences_per_chunk" name="multilevel_micro_sentences_per_chunk" value="{{ config.multilevel_micro_sentences_per_chunk }}" min="1" required>
                                </div>
                                <div>
                                    <label for="multilevel_micro_sentence_overlap">Перекрытие предложений в микро-чанках</label>
                                    <input type="number" id="multilevel_micro_sentence_overlap" name="multilevel_micro_sentence_overlap" value="{{ config.multilevel_micro_sentence_overlap }}" min="0" required>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <script>
                        // Показываем/скрываем настройки в зависимости от выбранной стратегии
                        document.addEventListener('DOMContentLoaded', function() {
                            const characterRadio = document.getElementById('chunking_character');
                            const paragraphRadio = document.getElementById('chunking_paragraph');
                            const sentenceRadio = document.getElementById('chunking_sentence');
                            const multilevelCheckbox = document.getElementById('use_multilevel_chunking');
                            const standardChunkingSettings = document.getElementById('standard-chunking-settings');
                            const multilevelChunkingSettings = document.getElementById('multilevel-chunking-settings');
                            const paragraphSettings = document.getElementById('paragraph-settings');
                            const sentenceSettings = document.getElementById('sentence-settings');
                            const macroStrategySelect = document.getElementById('multilevel_macro_strategy');
                            const microStrategySelect = document.getElementById('multilevel_micro_strategy');
                            const macroCharacterSettings = document.getElementById('multilevel-macro-character-settings');
                            const macroParagraphSettings = document.getElementById('multilevel-macro-paragraph-settings');
                            const macroSentenceSettings = document.getElementById('multilevel-macro-sentence-settings');
                            const microCharacterSettings = document.getElementById('multilevel-micro-character-settings');
                            const microParagraphSettings = document.getElementById('multilevel-micro-paragraph-settings');
                            const microSentenceSettings = document.getElementById('multilevel-micro-sentence-settings');
                            
                            function updateVisibility() {
                                // Показываем/скрываем настройки обычного или многоуровневого чанкинга
                                if (multilevelCheckbox && multilevelCheckbox.checked) {
                                    standardChunkingSettings.style.display = 'none';
                                    multilevelChunkingSettings.style.display = 'block';
                                } else {
                                    standardChunkingSettings.style.display = 'block';
                                    multilevelChunkingSettings.style.display = 'none';
                                    
                                    // Для обычного чанкинга показываем настройки стратегии
                                    if (paragraphRadio && paragraphRadio.checked) {
                                        paragraphSettings.style.display = 'block';
                                    } else if (sentenceRadio && sentenceRadio.checked) {
                                        sentenceSettings.style.display = 'block';
                                    } else {
                                        paragraphSettings.style.display = 'none';
                                        sentenceSettings.style.display = 'none';
                                    }
                                }
                            }
                            
                            function updateMacroStrategyVisibility() {
                                if (macroStrategySelect) {
                                    const selectedStrategy = macroStrategySelect.value;
                                    
                                    // Скрываем все макро-настройки
                                    macroCharacterSettings.style.display = 'none';
                                    macroParagraphSettings.style.display = 'none';
                                    macroSentenceSettings.style.display = 'none';
                                    
                                    // Показываем настройки для выбранной макро-стратегии
                                    if (selectedStrategy === 'character') {
                                        macroCharacterSettings.style.display = 'block';
                                    } else if (selectedStrategy === 'paragraph') {
                                        macroParagraphSettings.style.display = 'block';
                                    } else if (selectedStrategy === 'sentence') {
                                        macroSentenceSettings.style.display = 'block';
                                    }
                                }
                            }
                            
                            function updateMicroStrategyVisibility() {
                                if (microStrategySelect) {
                                    const selectedStrategy = microStrategySelect.value;
                                    
                                    // Скрываем все микро-настройки
                                    microCharacterSettings.style.display = 'none';
                                    microParagraphSettings.style.display = 'none';
                                    microSentenceSettings.style.display = 'none';
                                    
                                    // Показываем настройки для выбранной микро-стратегии
                                    if (selectedStrategy === 'character') {
                                        microCharacterSettings.style.display = 'block';
                                    } else if (selectedStrategy === 'paragraph') {
                                        microParagraphSettings.style.display = 'block';
                                    } else if (selectedStrategy === 'sentence') {
                                        microSentenceSettings.style.display = 'block';
                                    }
                                }
                            }
                            
                            // Обработчики для переключения между обычным и многоуровневым чанкингом
                            if (multilevelCheckbox) {
                                multilevelCheckbox.addEventListener('change', updateVisibility);
                            }
                            
                            // Обработчики для обычного чанкинга
                            if (characterRadio && paragraphRadio && sentenceRadio) {
                                characterRadio.addEventListener('change', updateVisibility);
                                paragraphRadio.addEventListener('change', updateVisibility);
                                sentenceRadio.addEventListener('change', updateVisibility);
                            }
                            
                            // Обработчики для многоуровневого чанкинга
                            if (macroStrategySelect) {
                                macroStrategySelect.addEventListener('change', updateMacroStrategyVisibility);
                            }
                            
                            if (microStrategySelect) {
                                microStrategySelect.addEventListener('change', updateMicroStrategyVisibility);
                            }
                            
                            // Инициализация при загрузке страницы
                            updateVisibility();
                            updateMacroStrategyVisibility();
                            updateMicroStrategyVisibility();
                        });
                    </script>
                    <div class="grid-2col">
                        <div>
                            <label for="embedding_batch_size">Batch size для эмбеддинга (HuggingFace)</label>
                            <input type="number" id="embedding_batch_size" name="embedding_batch_size" value="{{ config.embedding_batch_size }}" min="1" required>
                        </div>
                        <div>
                            <label for="indexing_batch_size">Batch size для индексации (Qdrant)</label>
                            <input type="number" id="indexing_batch_size" name="indexing_batch_size" value="{{ config.indexing_batch_size }}" min="1" required>
                        </div>
                    </div>
                    
                    <fieldset>
                        <legend>Типы векторов для индексации</legend>
                        <input type="radio" id="indexing_dense" name="indexing_type" value="dense" {% if config.index_dense and not config.index_hybrid %}checked{% endif %}>
                        <label for="indexing_dense">Плотные векторы (dense)</label><br>
                        <input type="radio" id="indexing_sparse" name="indexing_type" value="sparse" {% if config.index_bm25 and not config.index_hybrid %}checked{% endif %}>
                        <label for="indexing_sparse">Разреженные векторы (BM25)</label><br>
                        <input type="radio" id="indexing_hybrid" name="indexing_type" value="hybrid" {% if config.index_hybrid %}checked{% endif %}>
                        <label for="indexing_hybrid">Гибридный режим (dense + BM25)</label><br>
                        <!-- Hidden fields to store individual flags -->
                        <input type="hidden" id="index_dense" name="index_dense" value="{{ 'True' if config.index_dense else 'False' }}">
                        <input type="hidden" id="index_bm25" name="index_bm25" value="{{ 'True' if config.index_bm25 else 'False' }}">
                        <input type="hidden" id="index_hybrid" name="index_hybrid" value="{{ 'True' if config.index_hybrid else 'False' }}">
                        <!-- Legacy fields kept for compatibility -->
                        <input type="hidden" id="use_dense" name="use_dense" value="{{ 'True' if config.use_dense_vectors else 'False' }}">
                        <input type="hidden" id="use_hybrid" name="use_hybrid" value="{{ 'True' if config.use_hybrid else 'False' }}">
                    </fieldset>
                    
                    <fieldset>
                        <legend>Устройство для индексации</legend>
                        <input type="radio" id="dev_auto" name="device" value="auto" {% if config.device == 'auto' %}checked{% endif %}>
                        <label for="dev_auto">Авто</label>
                        <input type="radio" id="dev_cuda" name="device" value="cuda" {% if config.device == 'cuda' %}checked{% endif %}>
                        <label for="dev_cuda">GPU</label>
                        <input type="radio" id="dev_cpu" name="device" value="cpu" {% if config.device == 'cpu' %}checked{% endif %}>
                        <label for="dev_cpu">CPU</label>
                    </fieldset>
                    
                    <button type="submit">Сохранить настройки индексации</button>
                    <div class="progress">
                        <span class="spinner"></span> Сохранение настроек индексации...
                    </div>
                </form>
            </div>
            
            <div class="module-card">
                <h3>Управление индексом</h3>
                <p>Проиндексировать данные из <strong>{{ config.folder_path }}</strong> в коллекцию <strong>{{ config.collection_name }}</strong>.</p>
                <form action="/api/admin/run-indexing" method="post" class="action-form" data-action="run-indexing">
                    <button type="submit">Запустить индексацию</button>
                    <div class="progress">
                        <span class="spinner"></span> Индексация запущена в фоновом режиме...
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Conversion Module -->
        <div id="conversion-module" class="module-content">
            <div class="module-card">
                <h3>Настройки обработки PDF (MinerU - Subprocess)</h3>
                <p><strong>Важно:</strong> Убедитесь, что пакет `mineru` установлен и команда `mineru` доступна в вашем окружении.</p>
                
                <form action="/api/admin/update-settings" method="post" class="settings-form" data-module="conversion">
                    <input type="hidden" name="action" value="save_mineru_settings">
                    
                    <label for="mineru_input_pdf_dir">Папка с PDF файлами для обработки</label>
                    <input type="text" id="mineru_input_pdf_dir" name="mineru_input_pdf_dir" value="{{ config.mineru_input_pdf_dir }}" required>
                    
                    <label for="mineru_output_md_dir">Папка для сохранения Markdown файлов (вход для индексации)</label>
                    <input type="text" id="mineru_output_md_dir" name="mineru_output_md_dir" value="{{ config.mineru_output_md_dir }}" required>
                    
                    <div class="grid-3col">
                        <div>
                            <input type="checkbox" id="mineru_enable_formula_parsing" name="mineru_enable_formula_parsing" value="True" {% if config.mineru_enable_formula_parsing %}checked{% endif %}>
                            <label for="mineru_enable_formula_parsing">Парсинг формул</label>
                        </div>
                        <div>
                            <input type="checkbox" id="mineru_enable_table_parsing" name="mineru_enable_table_parsing" value="True" {% if config.mineru_enable_table_parsing %}checked{% endif %}>
                            <label for="mineru_enable_table_parsing">Парсинг таблиц</label>
                        </div>
                        <div>
                            <!-- Можно добавить другие опции, если понадобятся -->
                        </div>
                    </div>
                    
                    <div class="grid-2col">
                        <div>
                            <label for="mineru_backend">Бэкенд обработки</label>
                            <select id="mineru_backend" name="mineru_backend" required>
                                <option value="pipeline" {% if config.mineru_backend == 'pipeline' %}selected{% endif %}>Pipeline</option>
                                <option value="vlm-transformers" {% if config.mineru_backend == 'vlm-transformers' %}selected{% endif %}>VLM Transformers</option>
                                <option value="vlm-sglang-client" {% if config.mineru_backend == 'vlm-sglang-client' %}selected{% endif %}>VLM SGLang Client</option>
                            </select>
                        </div>
                        <div>
                            <label for="mineru_method">Метод парсинга</label>
                            <select id="mineru_method" name="mineru_method" required>
                                <option value="auto" {% if config.mineru_method == 'auto' %}selected{% endif %}>Auto</option>
                                <option value="txt" {% if config.mineru_method == 'txt' %}selected{% endif %}>TXT</option>
                                <option value="ocr" {% if config.mineru_method == 'ocr' %}selected{% endif %}>OCR</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="grid-2col">
                        <div>
                            <label for="mineru_lang">Язык для OCR</label>
                            <input type="text" id="mineru_lang" name="mineru_lang" value="{{ config.mineru_lang }}" required>
                        </div>
                        <div>
                            <label for="mineru_sglang_url">URL сервера SGLang (если backend=VLM SGLang Client)</label>
                            <input type="text" id="mineru_sglang_url" name="mineru_sglang_url" value="{{ config.mineru_sglang_url }}">
                        </div>
                    </div>

                    <fieldset>
                        <legend>Источник моделей для MinerU</legend>
                        <input type="radio" id="ms_hf" name="mineru_model_source" value="huggingface" {% if config.mineru_model_source == 'huggingface' %}checked{% endif %}>
                        <label for="ms_hf">Hugging Face</label>
                        <input type="radio" id="ms_ms" name="mineru_model_source" value="modelscope" {% if config.mineru_model_source == 'modelscope' %}checked{% endif %}>
                        <label for="ms_ms">ModelScope</label>
                        <input type="radio" id="ms_local" name="mineru_model_source" value="local" {% if config.mineru_model_source == 'local' %}checked{% endif %}>
                        <label for="ms_local">Локальные модели</label>
                    </fieldset>
                    
                    <label for="mineru_models_dir">Путь к локальным моделям (если выбрано 'Локальные модели')</label>
                    <input type="text" id="mineru_models_dir" name="mineru_models_dir" value="{{ config.mineru_models_dir }}">

                    <button type="submit">Сохранить настройки MinerU</button>
                    <div class="progress">
                        <span class="spinner"></span> Сохранение настроек MinerU...
                    </div>
                </form>
            </div>
            
            <div class="module-card">
                <h3>Обработка PDF</h3>
                <p>Преобразовать PDF из <strong>{{ config.mineru_input_pdf_dir }}</strong> в Markdown и сохранить в <strong>{{ config.mineru_output_md_dir }}</strong>.</p>
                <form action="/api/admin/process-pdfs" method="post" class="action-form" data-action="process-pdfs">
                    <button type="submit">Запустить обработку PDF (Subprocess)</button>
                    <div class="progress">
                        <span class="spinner"></span> Обработка PDF запущена в фоновом режиме...
                    </div>
                </form>
            </div>
            
            <div class="module-card">
                <h3>Обработка файлов различных форматов</h3>
                <p>Преобразовать файлы различных форматов из <strong>{{ config.mineru_input_pdf_dir }}</strong> в Markdown и сохранить в <strong>{{ config.mineru_output_md_dir }}</strong>.</p>
                <form action="/api/admin/process-files" method="post" class="action-form" data-action="process-files">
                    <button type="submit">Запустить обработку файлов</button>
                    <div class="progress">
                        <span class="spinner"></span> Обработка файлов запущена в фоновом режиме...
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Embedding Module -->
        <div id="embedding-module" class="module-content">
            <div class="module-card">
                <h3>Настройки эмбеддинга</h3>
                
                <form action="/api/admin/update-settings" method="post" class="settings-form" data-module="embedding">
                    <input type="hidden" name="action" value="save_advanced_settings">
                    
                    <label for="hf_model">Модель для плотных векторов (семантика)</label>
                    <input list="model-history-dense" id="hf_model" name="hf_model" value="{{ config.current_hf_model }}" required>
                    <datalist id="model-history-dense">
                        {% for model in config.hf_model_history %}
                            <option value="{{ model }}">{{ model }}</option>
                        {% endfor %}
                    </datalist>
                    
                    <label for="sparse_embedding">Модель для sparse embedding</label>
                    <input type="text" id="sparse_embedding" name="sparse_embedding" value="{{ config.sparse_embedding }}" required>
                    
                    <div class="form-info">
                        <p><strong>Директория кэша моделей sparse embedding:</strong> 
                           <span id="fastembed_cache_dir_display">
                               {% if fastembed_cache_dir %}
                                   {{ fastembed_cache_dir }}
                               {% else %}
                                   Не задана (используется директория по умолчанию)
                               {% endif %}
                           </span>
                        </p>
                        <p class="help-text">
                            Директория кэша моделей BM25 и других sparse моделей задается через переменную окружения FASTEMBED_CACHE_DIR в файле .env.
                        </p>
                    </div>
                    
                    <button type="submit">Сохранить настройки эмбеддинга</button>
                    <div class="progress">
                        <span class="spinner"></span> Сохранение настроек эмбеддинга...
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Search Module -->
        <div id="search-module" class="module-content">
            <div class="module-card">
                <h3>Настройки поиска</h3>
                
                <form action="/api/admin/update-settings" method="post" class="settings-form" data-module="search">
                    <input type="hidden" name="action" value="save_advanced_settings">
                    
                    <label for="search_default_k">Количество результатов поиска по умолчанию</label>
                    <input type="number" id="search_default_k" name="search_default_k" value="{{ config.search_default_k }}" min="1" required>
                    
                    <button type="submit">Сохранить настройки поиска</button>
                    <div class="progress">
                        <span class="spinner"></span> Сохранение настроек поиска...
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Qdrant Module -->
        <div id="qdrant-module" class="module-content">
            <div class="module-card">
                <h3>Настройки подключения к Qdrant</h3>
                
                <form action="/api/admin/update-settings" method="post" class="settings-form" data-module="qdrant">
                    <input type="hidden" name="action" value="save_advanced_settings">
                    
                    <label for="qdrant_url">URL Qdrant</label>
                    <input type="text" id="qdrant_url" name="qdrant_url" value="{{ config.qdrant_url }}" required>
                    
                    <div class="grid-2col">
                        <div>
                            <label for="qdrant_retry_attempts">Количество попыток повтора</label>
                            <input type="number" id="qdrant_retry_attempts" name="qdrant_retry_attempts" value="{{ config.qdrant_retry_attempts }}" min="1" required>
                        </div>
                        <div>
                            <label for="qdrant_retry_wait_time">Время ожидания между попытками (сек)</label>
                            <input type="number" id="qdrant_retry_wait_time" name="qdrant_retry_wait_time" value="{{ config.qdrant_retry_wait_time }}" min="1" required>
                        </div>
                    </div>
                    
                    <button type="submit">Сохранить настройки Qdrant</button>
                    <div class="progress">
                        <span class="spinner"></span> Сохранение настроек Qdrant...
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Collections Module -->
        <div id="collections-module" class="module-content">
            <div class="module-card">
                <h3>Управление коллекциями</h3>
                
                <form action="/api/admin/settings/delete-collection" method="post" class="action-form" data-action="delete-collection">
                    <label for="collection_to_delete">Удалить коллекцию:
                        <select id="collection_to_delete" name="collection_name" required>
                            <option value="">-- Выберите коллекцию --</option>
                            {% for c in collections %}
                                <option value="{{ c }}">{{ c }}</option>
                            {% endfor %}
                        </select>
                    </label>
                    <button type="submit" onclick="return confirm('Вы уверены, что хотите удалить выбранную коллекцию? Это действие необратимо.');">Удалить</button>
                    <div class="progress">
                        <span class="spinner"></span> Удаление коллекции...
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Advanced Module -->
        <div id="advanced-module" class="module-content">
            <div class="module-card">
                <h3>Настройки кэширования</h3>
                
                <form action="/api/admin/update-settings" method="post" class="settings-form" data-module="advanced">
                    <input type="hidden" name="action" value="save_advanced_settings">
                    
                    <div class="grid-3col">
                        <div>
                            <label for="config_cache_ttl">TTL кэша конфигурации (сек)</label>
                            <input type="number" id="config_cache_ttl" name="config_cache_ttl" value="{{ config.config_cache_ttl }}" min="1" required>
                        </div>
                        <div>
                            <label for="qdrant_client_cache_ttl">TTL кэша клиента Qdrant (сек)</label>
                            <input type="number" id="qdrant_client_cache_ttl" name="qdrant_client_cache_ttl" value="{{ config.qdrant_client_cache_ttl }}" min="1" required>
                        </div>
                        <div>
                            <label for="collections_cache_ttl">TTL кэша коллекций (сек)</label>
                            <input type="number" id="collections_cache_ttl" name="collections_cache_ttl" value="{{ config.collections_cache_ttl }}" min="1" required>
                        </div>
                    </div>
                    
                    <button type="submit">Сохранить настройки кэширования</button>
                    <div class="progress">
                        <span class="spinner"></span> Сохранение настроек кэширования...
                    </div>
                </form>
            </div>
            
            <div class="module-card">
                <h3>Настройки GGUF моделей</h3>
                
                <form action="/api/admin/update-settings" method="post" class="settings-form" data-module="advanced">
                    <input type="hidden" name="action" value="save_advanced_settings">
                    
                    <label for="gguf_model_n_ctx">Размер контекста для GGUF моделей</label>
                    <input type="number" id="gguf_model_n_ctx" name="gguf_model_n_ctx" value="{{ config.gguf_model_n_ctx }}" min="1" required>
                    
                    <button type="submit">Сохранить настройки GGUF</button>
                    <div class="progress">
                        <span class="spinner"></span> Сохранение настроек GGUF...
                    </div>
                </form>
            </div>
            
            <div class="module-card">
                <h3>Настройки индексации документов</h3>
                
                <form action="/api/admin/update-settings" method="post" class="settings-form" data-module="advanced">
                    <input type="hidden" name="action" value="save_advanced_settings">
                    
                    <div class="grid-2col">
                        <div>
                            <label for="memory_threshold">Порог памяти (байт)</label>
                            <input type="number" id="memory_threshold" name="memory_threshold" value="{{ config.memory_threshold }}" min="1" required>
                        </div>
                        <div>
                            <label for="indexing_default_batch_size">Размер батча по умолчанию</label>
                            <input type="number" id="indexing_default_batch_size" name="indexing_default_batch_size" value="{{ config.indexing_default_batch_size }}" min="1" required>
                        </div>
                    </div>
                    
                    <button type="submit">Сохранить настройки индексации документов</button>
                    <div class="progress">
                        <span class="spinner"></span> Сохранение настроек индексации документов...
                    </div>
                </form>
            </div>
            
            <div class="module-card">
                <h3>Настройки MinerU (дополнительные)</h3>
                
                <form action="/api/admin/update-settings" method="post" class="settings-form" data-module="advanced">
                    <input type="hidden" name="action" value="save_advanced_settings">
                    
                    <label for="mineru_subprocess_timeout">Таймаут subprocess вызова mineru (сек)</label>
                    <input type="number" id="mineru_subprocess_timeout" name="mineru_subprocess_timeout" value="{{ config.mineru_subprocess_timeout }}" min="1" required>
                    
                    <button type="submit">Сохранить дополнительные настройки MinerU</button>
                    <div class="progress">
                        <span class="spinner"></span> Сохранение дополнительных настроек MinerU...
                    </div>
                </form>
            </div>
            
            <div class="module-card">
                <h3>Информация о переменных окружения</h3>
                
                <div class="form-info">
                    <p><strong>Переменные окружения:</strong> Некоторые настройки задаются через переменные окружения в файле <code>.env</code>:</p>
                    <ul>
                        <li><code>ADMIN_API_KEY</code> - API ключ для защиты админки</li>
                        <li><code>FASTEMBED_CACHE_DIR</code> - Директория кэша моделей BM25 (по умолчанию <code>./models/fastembed_cache</code>)</li>
                    </ul>
                </div>
            </div>
        </div>
    </main>
    
    <script>
        // Module switching functionality
        document.querySelectorAll('.module-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                // Remove active class from all tabs and content
                document.querySelectorAll('.module-tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.module-content').forEach(c => c.classList.remove('active'));
                
                // Add active class to clicked tab
                tab.classList.add('active');
                
                // Show corresponding content
                const module = tab.getAttribute('data-module');
                document.getElementById(`${module}-module`).classList.add('active');
            });
        });
        
        // Функция для выполнения AJAX POST запроса
        async function ajaxPost(url, data) {
            const formData = new FormData();
            for (const key in data) {
                if (data.hasOwnProperty(key)) {
                    formData.append(key, data[key]);
                }
            }
            
            // Проверяем, что URL корректный
            if (!url || typeof url !== 'string') {
                throw new Error('Invalid URL provided');
            }
            
            const response = await fetch(url, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            });
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const contentType = response.headers.get('content-type');
            if (contentType && contentType.includes('application/json')) {
                return await response.json();
            } else {
                return await response.text();
            }
        }
        
        // Функция для отображения сообщения об ошибке
        function showErrorMessage(message) {
            const errorContainer = document.getElementById('error-message');
            if (errorContainer) {
                errorContainer.textContent = message;
                errorContainer.style.display = 'block';
            }
        }
        
        // Функция для скрытия сообщения об ошибке
        function hideErrorMessage() {
            const errorContainer = document.getElementById('error-message');
            if (errorContainer) {
                errorContainer.style.display = 'none';
            }
        }
        
        // Функция для отображения сообщения об успехе
        function showSuccessMessage(message) {
            const successContainer = document.getElementById('success-message');
            if (successContainer) {
                successContainer.textContent = message;
                successContainer.style.display = 'block';
            }
        }
        
        // Функция для скрытия сообщения об успехе
        function hideSuccessMessage() {
            const successContainer = document.getElementById('success-message');
            if (successContainer) {
                successContainer.style.display = 'none';
            }
        }
        
        // Функция для отображения индикатора загрузки
        function showLoadingIndicator(formElement) {
            const progress = formElement.querySelector('.progress');
            if (progress) {
                progress.style.display = 'block';
            }
        }
        
        // Функция для скрытия индикатора загрузки
        function hideLoadingIndicator(formElement) {
            const progress = formElement.querySelector('.progress');
            if (progress) {
                progress.style.display = 'none';
            }
        }
        
        // Обработчики событий для форм с индикаторами прогресса
        function handleFormSubmit(event) {
            event.preventDefault();
            
            const form = event.target;
            
            // Скрываем сообщения
            hideErrorMessage();
            hideSuccessMessage();
            
            // Отображаем индикатор загрузки
            showLoadingIndicator(form);
            
            // Блокируем кнопку отправки
            const submitButton = form.querySelector('button[type="submit"]');
            if (submitButton) {
                submitButton.disabled = true;
            }
            
            // Собираем данные формы
            const formData = new FormData(form);
            const action = formData.get('action');
            
            // Получаем URL из атрибута action формы, с проверкой на корректность
            let formAction = form.getAttribute('action');
            if (!formAction || typeof formAction !== 'string') {
                formAction = '/api/admin/update-settings'; // URL по умолчанию
            }
            
            // Отправляем данные
            ajaxPost(formAction, Object.fromEntries(formData))
                .then(response => {
                    if (response.status === 'saved') {
                        showSuccessMessage('Настройки успешно сохранены.');
                    } else if (response.status === 'indexing_started') {
                        showSuccessMessage('Индексация запущена в фоновом режиме.');
                    } else if (response.status === 'processing_started') {
                        showSuccessMessage('Обработка запущена в фоновом режиме.');
                    } else if (response.status && response.status.includes('deleted_')) {
                        showSuccessMessage('Коллекция успешно удалена.');
                        // Обновляем страницу для обновления списка коллекций
                        location.reload();
                    } else if (response.status === 'delete_error') {
                        showErrorMessage('Ошибка при удалении коллекции.');
                    } else if (response.status === 'error_no_collection_selected') {
                        showErrorMessage('Не выбрана коллекция для удаления.');
                    } else {
                        showErrorMessage('Ошибка при сохранении настроек.');
                    }
                })
                .catch(error => {
                    console.error('Ошибка при отправке формы:', error);
                    showErrorMessage('Произошла ошибка. Пожалуйста, попробуйте еще раз.');
                })
                .finally(() => {
                    // Скрываем индикатор загрузки
                    hideLoadingIndicator(form);
                    
                    // Разблокируем кнопку отправки
                    if (submitButton) {
                        submitButton.disabled = false;
                    }
                });
        }
        
        // Простой обработчик для чекбокса index_hybrid
        function setupIndexHybridHandler() {
            try {
                var checkbox = document.getElementById('index_hybrid');
                if (checkbox) {
                    checkbox.addEventListener('change', function() {
                        if (this.checked) {
                            document.getElementById('index_dense').checked = true;
                        }
                    });
                }
            } catch (e) {
                console.log("Error setting up index_hybrid handler:", e);
            }
        }
        
        // Инициализация обработчиков после загрузки DOM
        document.addEventListener('DOMContentLoaded', function() {
            setupIndexHybridHandler();
            
            // Добавляем обработчики для всех форм настроек
            document.querySelectorAll('.settings-form').forEach(form => {
                form.addEventListener('submit', handleFormSubmit);
            });
            
            // Добавляем обработчики для всех форм действий
            document.querySelectorAll('.action-form').forEach(form => {
                form.addEventListener('submit', handleFormSubmit);
            });
            
            // Обработчики событий для радиокнопок индексации
            document.getElementById('indexing_dense').addEventListener('change', function() {
                if (this.checked) {
                    document.getElementById('index_dense').value = 'True';
                    document.getElementById('index_bm25').value = 'False';
                    document.getElementById('index_hybrid').value = 'False';
                }
            });
            
            document.getElementById('indexing_sparse').addEventListener('change', function() {
                if (this.checked) {
                    document.getElementById('index_dense').value = 'False';
                    document.getElementById('index_bm25').value = 'True';
                    document.getElementById('index_hybrid').value = 'False';
                }
            });
            
            document.getElementById('indexing_hybrid').addEventListener('change', function() {
                if (this.checked) {
                    document.getElementById('index_dense').value = 'True';
                    document.getElementById('index_bm25').value = 'True';  // Гибрид подразумевает sparse
                    document.getElementById('index_hybrid').value = 'True';
                }
            });
        });
    </script>
</body>
</html>