<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Настройки</title>
    <link rel="stylesheet" href="/static/simple.min.css">
    <!-- Подключаем Alpine.js -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <style>
        .status-msg { padding: 1rem; margin-bottom: 1rem; border-radius: 4px; }
        .success { background-color: #d4edda; color: #155724; }
        .info { background-color: #cce5ff; color: #004085; }
        .error { background-color: #f8d7da; color: #721c24; }
        fieldset { margin-top: 1rem; }
        legend { font-weight: bold; }
        .grid-2col { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
        .grid-3col { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem; }
        .grid-4col { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 1rem; }
        .form-section { border: 1px solid #ccc; border-radius: 4px; padding: 1rem; margin-bottom: 1rem; }
        .form-section h3 { margin-top: 0; }
        .progress { padding: 1rem; margin: 1rem 0; background-color: #f0f0f0; border-radius: 4px; }
        .spinner { display: inline-block; width: 20px; height: 20px; border: 3px solid #f3f3f3; border-top: 3px solid #3498db; border-radius: 50%; animation: spin 1s linear infinite; margin-right: 10px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .collapsible { cursor: pointer; padding: 10px; background-color: #f1f1f1; border: none; text-align: left; outline: none; }
        .content { padding: 0 18px; display: none; overflow: hidden; background-color: #f9f9f9; }
        .form-info { background-color: #e9ecef; padding: 1rem; border-radius: 4px; margin-bottom: 1rem; }
        .form-info p { margin: 0 0 0.5rem 0; }
        .form-info ul { margin: 0.5rem 0; padding-left: 1.5rem; }
        .help-text { font-size: 0.9em; color: #6c757d; margin: 0.5rem 0 0 0; }
        
        /* New styles for modular settings */
        .module-tabs { display: flex; flex-wrap: wrap; margin-bottom: 1rem; border-bottom: 1px solid #ccc; }
        .module-tab { padding: 1rem; background-color: #f8f9fa; border: 1px solid #ccc; border-bottom: none; cursor: pointer; margin-right: 0.5rem; border-radius: 4px 4px 0 0; }
        .module-tab.active { background-color: #fff; font-weight: bold; }
        .module-tab:hover:not(.active) { background-color: #e9ecef; }
        .module-card { border: 1px solid #ccc; border-radius: 4px; padding: 1rem; margin-bottom: 1rem; background-color: #fff; }
        .module-card h3 { margin-top: 0; color: #333; }
        
        /* Стили для Alpine.js */
        .hidden { display: none !important; }
    </style>
</head>
<body>
    <header>
        <h1>Настройки и Управление</h1>
        <nav><a href="/">Поиск</a> <a href="/settings/">Настройки</a></nav>
    </header>
    <main x-data="{
        activeTab: (new URLSearchParams(window.location.search)).get('tab') || 'indexing',
        useMultilevel: {{ 'true' if config.use_multilevel_chunking else 'false' }},
        chunkingStrategy: '{{ config.chunking_strategy }}',
        macroStrategy: '{{ config.multilevel_macro_strategy }}',
        microStrategy: '{{ config.multilevel_micro_strategy }}',
        // Состояние для управления AJAX запросами
        isProcessing: false,
        successMessage: '',
        errorMessage: '',
        showSuccessMessage(message) {
            this.successMessage = message;
            setTimeout(() => {
                this.successMessage = '';
            }, 5000);
        },
        showErrorMessage(message) {
            this.errorMessage = message;
            setTimeout(() => {
                this.errorMessage = '';
            }, 5000);
        },
        // Функции для обработки форм
        async submitSettingsForm(event) {
            event.preventDefault();
            const form = event.target;
            
            // Получаем модуль из data-атрибута формы
            const module = form.getAttribute('data-module');
            
            // Показываем индикатор прогресса
            this.isProcessing = true;
            
            try {
                // Собираем данные формы
                const formData = new FormData(form);
                
                // Отправляем данные через fetch
                const response = await fetch('/api/admin/update-settings', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                // Обрабатываем ответ
                if (data.status === 'saved') {
                    this.showSuccessMessage('Настройки успешно сохранены.');
                } else if (data.status === 'error') {
                    this.showErrorMessage(data.message || 'Ошибка сохранения настроек.');
                } else {
                    this.showSuccessMessage('Настройки сохранены.');
                }
            } catch (error) {
                console.error('Error saving settings:', error);
                this.showErrorMessage('Ошибка сохранения настроек: ' + error.message);
            } finally {
                // Скрываем индикатор прогресса
                this.isProcessing = false;
            }
        },
        async runIndexing() {
            // Показываем индикатор прогресса
            this.isProcessing = true;
            
            try {
                // Отправляем данные через fetch
                const response = await fetch('/api/admin/run-indexing', {
                    method: 'POST',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                // Обрабатываем ответ
                if (data.status === 'indexing_started') {
                    this.showSuccessMessage('Индексация запущена в фоновом режиме.');
                } else if (data.status === 'error') {
                    this.showErrorMessage(data.message || 'Ошибка запуска индексации.');
                } else {
                    this.showSuccessMessage('Индексация запущена.');
                }
            } catch (error) {
                console.error('Error starting indexing:', error);
                this.showErrorMessage('Ошибка запуска индексации: ' + error.message);
            } finally {
                // Скрываем индикатор прогресса
                this.isProcessing = false;
            }
        },
        async processFiles() {
            // Показываем индикатор прогресса
            this.isProcessing = true;
            
            try {
                // Отправляем данные через fetch
                const response = await fetch('/api/admin/process-files', {
                    method: 'POST',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                // Обрабатываем ответ
                if (data.status === 'processing_started') {
                    this.showSuccessMessage('Обработка файлов запущена в фоновом режиме.');
                } else if (data.status === 'error') {
                    this.showErrorMessage(data.message || 'Ошибка запуска обработки файлов.');
                } else {
                    this.showSuccessMessage('Обработка файлов запущена.');
                }
            } catch (error) {
                console.error('Error starting file processing:', error);
                this.showErrorMessage('Ошибка запуска обработки файлов: ' + error.message);
            } finally {
                // Скрываем индикатор прогресса
                this.isProcessing = false;
            }
        }
    }">
        {% if status and status_message %}
            <div class="status-msg {{ status_type }}">
                {{ status_message }}
            </div>
        {% endif %}
        
        <!-- Сообщения об ошибках и успехах -->
        <div id="error-message"></div>
        <div id="success-message"></div>
        
        <!-- Module Tabs -->
        <div class="module-tabs">
            <div class="module-tab" 
                 :class="{ 'active': activeTab === 'indexing' }"
                 @click="activeTab = 'indexing'"
                 data-module="indexing">Индексация</div>
            <div class="module-tab" 
                 :class="{ 'active': activeTab === 'conversion' }"
                 @click="activeTab = 'conversion'"
                 data-module="conversion">Конвертация</div>
            <div class="module-tab" 
                 :class="{ 'active': activeTab === 'embedding' }"
                 @click="activeTab = 'embedding'"
                 data-module="embedding">Эмбеддинг</div>
            <div class="module-tab" 
                 :class="{ 'active': activeTab === 'search' }"
                 @click="activeTab = 'search'"
                 data-module="search">Поиск</div>
            <div class="module-tab" 
                 :class="{ 'active': activeTab === 'qdrant' }"
                 @click="activeTab = 'qdrant'"
                 data-module="qdrant">Qdrant</div>
            <div class="module-tab" 
                 :class="{ 'active': activeTab === 'collections' }"
                 @click="activeTab = 'collections'"
                 data-module="collections">Коллекции</div>
            <div class="module-tab" 
                 :class="{ 'active': activeTab === 'advanced' }"
                 @click="activeTab = 'advanced'"
                 data-module="advanced">Продвинутые</div>
            <div class="module-tab" 
                 :class="{ 'active': activeTab === 'reranker' }"
                 @click="activeTab = 'reranker'"
                 data-module="reranker">Reranker</div>
        </div>
        
        <!-- Indexing Module -->
        <div id="indexing-module" class="module-content" x-show="activeTab === 'indexing'">
            <div class="module-card">
                <h3>Настройки индексации</h3>
                
                <form action="/api/admin/update-settings" method="post" class="settings-form" data-module="indexing" @submit="submitSettingsForm">
                    <input type="hidden" name="action" value="save_index_settings">
                    <input type="hidden" name="active_tab" value="indexing">
                    
                    <label for="folder_path">Папка для индексации (TXT и MD файлы)</label>
                    <input type="text" id="folder_path" name="folder_path" value="{{ config.folder_path }}" required>
                    
                    <label for="collection_name">Имя новой коллекции</label>
                    <input type="text" id="collection_name" name="collection_name" value="{{ config.collection_name }}" required>
                    
                    <div style="margin-top: 1rem;">
                        <input type="checkbox" id="use_multilevel_chunking" name="use_multilevel_chunking" value="True" 
                               x-model="useMultilevel"
                               {% if config.use_multilevel_chunking %}checked{% endif %}>
                        <label for="use_multilevel_chunking">Использовать многоуровневый чанкинг</label>
                    </div>
                    
                    <!-- Обычный чанкинг (когда многоуровневый не используется) -->
                    <div id="standard-chunking-settings" 
                         x-show="!useMultilevel"
                         style="margin-top: 1rem; padding: 1rem; border: 1px solid #ccc; border-radius: 4px;">
                        <h4>Настройки обычного чанкинга</h4>
                        
                        <div class="grid-2col">
                            <div>
                                <label for="chunk_size">Размер чанка (символы)</label>
                                <input type="number" id="chunk_size" name="chunk_size" value="{{ config.chunk_size }}" required>
                            </div>
                            <div>
                                <label for="chunk_overlap">Перекрытие чанков (символы)</label>
                                <input type="number" id="chunk_overlap" name="chunk_overlap" value="{{ config.chunk_overlap }}" required>
                            </div>
                        </div>
                        
                        <fieldset style="margin-top: 1rem;">
                            <legend>Стратегия чанкинга</legend>
                            <input type="radio" id="chunking_character" name="chunking_strategy" value="character" 
                                   x-model="chunkingStrategy" {% if config.chunking_strategy == 'character' %}checked{% endif %}>
                            <label for="chunking_character">По символам</label><br>
                            <input type="radio" id="chunking_paragraph" name="chunking_strategy" value="paragraph" 
                                   x-model="chunkingStrategy" {% if config.chunking_strategy == 'paragraph' %}checked{% endif %}>
                            <label for="chunking_paragraph">По абзацам</label><br>
                            <input type="radio" id="chunking_sentence" name="chunking_strategy" value="sentence" 
                                   x-model="chunkingStrategy" {% if config.chunking_strategy == 'sentence' %}checked{% endif %}>
                            <label for="chunking_sentence">По предложениям</label><br>
                            
                            <div id="paragraph-settings" 
                                 x-show="chunkingStrategy === 'paragraph'"
                                 style="margin-top: 1rem; padding: 1rem; border: 1px solid #eee; border-radius: 4px;">
                                <div class="grid-2col">
                                    <div>
                                        <label for="paragraphs_per_chunk">Абзацев в чанке</label>
                                        <input type="number" id="paragraphs_per_chunk" name="paragraphs_per_chunk" value="{{ config.paragraphs_per_chunk }}" min="1" required>
                                    </div>
                                    <div>
                                        <label for="paragraph_overlap">Перекрытие абзацев</label>
                                        <input type="number" id="paragraph_overlap" name="paragraph_overlap" value="{{ config.paragraph_overlap }}" min="0" required>
                                    </div>
                                </div>
                            </div>
                            
                            <div id="sentence-settings" 
                                 x-show="chunkingStrategy === 'sentence'"
                                 style="margin-top: 1rem; padding: 1rem; border: 1px solid #eee; border-radius: 4px;">
                                <div class="grid-2col">
                                    <div>
                                        <label for="sentences_per_chunk">Предложений в чанке</label>
                                        <input type="number" id="sentences_per_chunk" name="sentences_per_chunk" value="{{ config.sentences_per_chunk }}" min="1" required>
                                    </div>
                                    <div>
                                        <label for="sentence_overlap">Перекрытие предложений</label>
                                        <input type="number" id="sentence_overlap" name="sentence_overlap" value="{{ config.sentence_overlap }}" min="0" required>
                                    </div>
                                </div>
                            </div>
                        </fieldset>
                    </div>
                    
                    <!-- Многоуровневый чанкинг -->
                    <div id="multilevel-chunking-settings" 
                         x-show="useMultilevel"
                         style="margin-top: 1rem; padding: 1rem; border: 1px solid #ccc; border-radius: 4px;">
                        <h4>Настройки многоуровневого чанкинга</h4>
                        
                        <div style="margin-top: 1rem;">
                            <label for="multilevel_macro_strategy">Стратегия макро-чанкинга (основные чанки):</label>
                            <select id="multilevel_macro_strategy" name="multilevel_macro_strategy" x-model="macroStrategy">
                                <option value="character" {% if config.multilevel_macro_strategy == 'character' %}selected{% endif %}>По символам</option>
                                <option value="paragraph" {% if config.multilevel_macro_strategy == 'paragraph' %}selected{% endif %}>По абзацам</option>
                                <option value="sentence" {% if config.multilevel_macro_strategy == 'sentence' %}selected{% endif %}>По предложениям</option>
                            </select>
                        </div>
                        
                        <div id="multilevel-macro-character-settings" 
                             x-show="macroStrategy === 'character'"
                             style="margin-top: 1rem; padding: 1rem; border: 1px solid #eee; border-radius: 4px;">
                            <div class="grid-2col">
                                <div>
                                    <label for="multilevel_macro_chunk_size">Размер макро-чанка (символы)</label>
                                    <input type="number" id="multilevel_macro_chunk_size" name="multilevel_macro_chunk_size" value="{{ config.multilevel_macro_chunk_size }}" min="1000" required>
                                </div>
                                <div>
                                    <label for="multilevel_macro_chunk_overlap">Перекрытие макро-чанков (символы)</label>
                                    <input type="number" id="multilevel_macro_chunk_overlap" name="multilevel_macro_chunk_overlap" value="{{ config.multilevel_macro_chunk_overlap }}" min="0" required>
                                </div>
                            </div>
                        </div>
                        
                        <div id="multilevel-macro-paragraph-settings" 
                             x-show="macroStrategy === 'paragraph'"
                             style="margin-top: 1rem; padding: 1rem; border: 1px solid #eee; border-radius: 4px;">
                            <div class="grid-2col">
                                <div>
                                    <label for="multilevel_macro_paragraphs_per_chunk">Абзацев в макро-чанке</label>
                                    <input type="number" id="multilevel_macro_paragraphs_per_chunk" name="multilevel_macro_paragraphs_per_chunk" value="{{ config.multilevel_macro_paragraphs_per_chunk }}" min="1" required>
                                </div>
                                <div>
                                    <label for="multilevel_macro_paragraph_overlap">Перекрытие абзацев в макро-чанках</label>
                                    <input type="number" id="multilevel_macro_paragraph_overlap" name="multilevel_macro_paragraph_overlap" value="{{ config.multilevel_macro_paragraph_overlap }}" min="0" required>
                                </div>
                            </div>
                        </div>
                        
                        <div id="multilevel-macro-sentence-settings" 
                             x-show="macroStrategy === 'sentence'"
                             style="margin-top: 1rem; padding: 1rem; border: 1px solid #eee; border-radius: 4px;">
                            <div class="grid-2col">
                                <div>
                                    <label for="multilevel_macro_sentences_per_chunk">Предложений в макро-чанке</label>
                                    <input type="number" id="multilevel_macro_sentences_per_chunk" name="multilevel_macro_sentences_per_chunk" value="{{ config.multilevel_macro_sentences_per_chunk }}" min="1" required>
                                </div>
                                <div>
                                    <label for="multilevel_macro_sentence_overlap">Перекрытие предложений в макро-чанках</label>
                                    <input type="number" id="multilevel_macro_sentence_overlap" name="multilevel_macro_sentence_overlap" value="{{ config.multilevel_macro_sentence_overlap }}" min="0" required>
                                </div>
                            </div>
                        </div>
                        
                        <div style="margin-top: 1rem;">
                            <label for="multilevel_micro_strategy">Стратегия микро-чанкинга (дополнительные векторы):</label>
                            <select id="multilevel_micro_strategy" name="multilevel_micro_strategy" x-model="microStrategy">
                                <option value="character" {% if config.multilevel_micro_strategy == 'character' %}selected{% endif %}>По символам</option>
                                <option value="paragraph" {% if config.multilevel_micro_strategy == 'paragraph' %}selected{% endif %}>По абзацам</option>
                                <option value="sentence" {% if config.multilevel_micro_strategy == 'sentence' %}selected{% endif %}>По предложениям</option>
                            </select>
                        </div>
                        
                        <div id="multilevel-micro-character-settings" 
                             x-show="microStrategy === 'character'"
                             style="margin-top: 1rem; padding: 1rem; border: 1px solid #eee; border-radius: 4px;">
                            <div class="grid-2col">
                                <div>
                                    <label for="multilevel_micro_chunk_size">Размер микро-чанка (символы)</label>
                                    <input type="number" id="multilevel_micro_chunk_size" name="multilevel_micro_chunk_size" value="{{ config.multilevel_micro_chunk_size }}" min="100" required>
                                </div>
                                <div>
                                    <label for="multilevel_micro_chunk_overlap">Перекрытие микро-чанков (символы)</label>
                                    <input type="number" id="multilevel_micro_chunk_overlap" name="multilevel_micro_chunk_overlap" value="{{ config.multilevel_micro_chunk_overlap }}" min="0" required>
                                </div>
                            </div>
                        </div>
                        
                        <div id="multilevel-micro-paragraph-settings" 
                             x-show="microStrategy === 'paragraph'"
                             style="margin-top: 1rem; padding: 1rem; border: 1px solid #eee; border-radius: 4px;">
                            <div class="grid-2col">
                                <div>
                                    <label for="multilevel_micro_paragraphs_per_chunk">Абзацев в микро-чанке</label>
                                    <input type="number" id="multilevel_micro_paragraphs_per_chunk" name="multilevel_micro_paragraphs_per_chunk" value="{{ config.multilevel_micro_paragraphs_per_chunk }}" min="1" required>
                                </div>
                                <div>
                                    <label for="multilevel_micro_paragraph_overlap">Перекрытие абзацев в микро-чанках</label>
                                    <input type="number" id="multilevel_micro_paragraph_overlap" name="multilevel_micro_paragraph_overlap" value="{{ config.multilevel_micro_paragraph_overlap }}" min="0" required>
                                </div>
                            </div>
                        </div>
                        
                        <div id="multilevel-micro-sentence-settings" 
                             x-show="microStrategy === 'sentence'"
                             style="margin-top: 1rem; padding: 1rem; border: 1px solid #eee; border-radius: 4px;">
                            <div class="grid-2col">
                                <div>
                                    <label for="multilevel_micro_sentences_per_chunk">Предложений в микро-чанке</label>
                                    <input type="number" id="multilevel_micro_sentences_per_chunk" name="multilevel_micro_sentences_per_chunk" value="{{ config.multilevel_micro_sentences_per_chunk }}" min="1" required>
                                </div>
                                <div>
                                    <label for="multilevel_micro_sentence_overlap">Перекрытие предложений в микро-чанках</label>
                                    <input type="number" id="multilevel_micro_sentence_overlap" name="multilevel_micro_sentence_overlap" value="{{ config.multilevel_micro_sentence_overlap }}" min="0" required>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="grid-2col">
                        <div>
                            <label for="embedding_batch_size">Batch size для эмбеддинга (HuggingFace)</label>
                            <input type="number" id="embedding_batch_size" name="embedding_batch_size" value="{{ config.embedding_batch_size }}" min="1" required>
                        </div>
                        <div>
                            <label for="indexing_batch_size">Batch size для индексации (Qdrant)</label>
                            <input type="number" id="indexing_batch_size" name="indexing_batch_size" value="{{ config.indexing_batch_size }}" min="1" required>
                        </div>
                    </div>
                    
                    <fieldset>
                        <legend>Типы векторов для индексации</legend>
                        <input type="radio" id="indexing_dense" name="indexing_type" value="dense" {% if config.index_dense and not config.index_hybrid %}checked{% endif %}>
                        <label for="indexing_dense">Плотные векторы (dense)</label><br>
                        <input type="radio" id="indexing_sparse" name="indexing_type" value="sparse" {% if config.index_bm25 and not config.index_hybrid %}checked{% endif %}>
                        <label for="indexing_sparse">Разреженные векторы (BM25)</label><br>
                        <input type="radio" id="indexing_hybrid" name="indexing_type" value="hybrid" {% if config.index_hybrid %}checked{% endif %}>
                        <label for="indexing_hybrid">Гибридный режим (dense + BM25)</label><br>
                        <!-- Hidden fields to store individual flags -->
                        <input type="hidden" id="index_dense" name="index_dense" value="{{ 'True' if config.index_dense else 'False' }}">
                        <input type="hidden" id="index_bm25" name="index_bm25" value="{{ 'True' if config.index_bm25 else 'False' }}">
                        <input type="hidden" id="index_hybrid" name="index_hybrid" value="{{ 'True' if config.index_hybrid else 'False' }}">
                        <!-- Legacy fields kept for compatibility -->
                        <input type="hidden" id="use_dense" name="use_dense" value="{{ 'True' if config.index_dense else 'False' }}">
                        <input type="hidden" id="use_hybrid" name="use_hybrid" value="{{ 'True' if config.index_hybrid else 'False' }}">
                    </fieldset>
                    
                    <fieldset>
                        <legend>Устройство для индексации</legend>
                        <input type="radio" id="dev_auto" name="device" value="auto" {% if config.device == 'auto' %}checked{% endif %}>
                        <label for="dev_auto">Авто</label>
                        <input type="radio" id="dev_cuda" name="device" value="cuda" {% if config.device == 'cuda' %}checked{% endif %}>
                        <label for="dev_cuda">GPU</label>
                        <input type="radio" id="dev_cpu" name="device" value="cpu" {% if config.device == 'cpu' %}checked{% endif %}>
                        <label for="dev_cpu">CPU</label>
                    </fieldset>
                    
                    <button type="submit" :disabled="isProcessing">Сохранить настройки индексации</button>
                    <div class="progress" x-show="isProcessing">
                        <span class="spinner"></span> Сохранение настроек индексации...
                    </div>
                </form>
            </div>
            
            <div class="module-card">
                <h3>Управление индексом</h3>
                <p>Проиндексировать данные из <strong>{{ config.folder_path }}</strong> в коллекцию <strong>{{ config.collection_name }}</strong>.</p>
                <form action="/api/admin/run-indexing" method="post" class="action-form" data-action="run-indexing" @submit.prevent="runIndexing">
                    <button type="submit" :disabled="isProcessing">Запустить индексацию</button>
                    <div class="progress" x-show="isProcessing">
                        <span class="spinner"></span> Индексация запущена в фоновом режиме...
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Conversion Module -->
        <div id="conversion-module" class="module-content" x-show="activeTab === 'conversion'">
            <div class="module-card">
                <h3>Настройки обработки PDF (MinerU - Subprocess)</h3>
                <p><strong>Важно:</strong> Убедитесь, что пакет `mineru` установлен и команда `mineru` доступна в вашем окружении.</p>
                
                <form action="/api/admin/update-settings" method="post" class="settings-form" data-module="conversion" @submit="submitSettingsForm">
                    <input type="hidden" name="action" value="save_mineru_settings">
                    <input type="hidden" name="active_tab" value="conversion">
                    
                    <label for="mineru_input_pdf_dir">Папка с PDF файлами для обработки</label>
                    <input type="text" id="mineru_input_pdf_dir" name="mineru_input_pdf_dir" value="{{ config.mineru_input_pdf_dir }}" required>
                    
                    <label for="mineru_output_md_dir">Папка для сохранения Markdown файлов (вход для индексации)</label>
                    <input type="text" id="mineru_output_md_dir" name="mineru_output_md_dir" value="{{ config.mineru_output_md_dir }}" required>
                    
                    <div class="grid-3col">
                        <div>
                            <input type="checkbox" id="mineru_enable_formula_parsing" name="mineru_enable_formula_parsing" value="True" {% if config.mineru_enable_formula_parsing %}checked{% endif %}>
                            <label for="mineru_enable_formula_parsing">Парсинг формул</label>
                        </div>
                        <div>
                            <input type="checkbox" id="mineru_enable_table_parsing" name="mineru_enable_table_parsing" value="True" {% if config.mineru_enable_table_parsing %}checked{% endif %}>
                            <label for="mineru_enable_table_parsing">Парсинг таблиц</label>
                        </div>
                        <div>
                            <!-- Можно добавить другие опции, если понадобятся -->
                        </div>
                    </div>
                    
                    <div class="grid-2col">
                        <div>
                            <label for="mineru_backend">Бэкенд обработки</label>
                            <select id="mineru_backend" name="mineru_backend" required>
                                <option value="pipeline" {% if config.mineru_backend == 'pipeline' %}selected{% endif %}>Pipeline</option>
                                <option value="vlm-transformers" {% if config.mineru_backend == 'vlm-transformers' %}selected{% endif %}>VLM Transformers</option>
                                <option value="vlm-sglang-client" {% if config.mineru_backend == 'vlm-sglang-client' %}selected{% endif %}>VLM SGLang Client</option>
                            </select>
                        </div>
                        <div>
                            <label for="mineru_method">Метод парсинга</label>
                            <select id="mineru_method" name="mineru_method" required>
                                <option value="auto" {% if config.mineru_method == 'auto' %}selected{% endif %}>Auto</option>
                                <option value="txt" {% if config.mineru_method == 'txt' %}selected{% endif %}>TXT</option>
                                <option value="ocr" {% if config.mineru_method == 'ocr' %}selected{% endif %}>OCR</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="grid-2col">
                        <div>
                            <label for="mineru_lang">Язык для OCR</label>
                            <input type="text" id="mineru_lang" name="mineru_lang" value="{{ config.mineru_lang }}" required>
                        </div>
                        <div>
                            <label for="mineru_sglang_url">URL сервера SGLang (если backend=VLM SGLang Client)</label>
                            <input type="text" id="mineru_sglang_url" name="mineru_sglang_url" value="{{ config.mineru_sglang_url }}">
                        </div>
                    </div>

                    <fieldset>
                        <legend>Источник моделей для MinerU</legend>
                        <input type="radio" id="ms_hf" name="mineru_model_source" value="huggingface" {% if config.mineru_model_source == 'huggingface' %}checked{% endif %}>
                        <label for="ms_hf">Hugging Face</label>
                        <input type="radio" id="ms_ms" name="mineru_model_source" value="modelscope" {% if config.mineru_model_source == 'modelscope' %}checked{% endif %}>
                        <label for="ms_ms">ModelScope</label>
                        <input type="radio" id="ms_local" name="mineru_model_source" value="local" {% if config.mineru_model_source == 'local' %}checked{% endif %}>
                        <label for="ms_local">Локальные модели</label>
                    </fieldset>
                    
                    <label for="mineru_models_dir">Путь к локальным моделям (если выбрано 'Локальные модели')</label>
                    <input type="text" id="mineru_models_dir" name="mineru_models_dir" value="{{ config.mineru_models_dir }}">

                    <button type="submit" :disabled="isProcessing">Сохранить настройки MinerU</button>
                    <div class="progress" x-show="isProcessing">
                        <span class="spinner"></span> Сохранение настроек MinerU...
                    </div>
                </form>
            </div>
            
            <div class="module-card">
                <h3>Обработка файлов различных форматов</h3>
                <p>Преобразовать файлы различных форматов из <strong>{{ config.mineru_input_pdf_dir }}</strong> в Markdown и сохранить в <strong>{{ config.mineru_output_md_dir }}</strong>.</p>
                <form action="/api/admin/process-files" method="post" class="action-form" data-action="process-files" @submit.prevent="processFiles">
                    <button type="submit" :disabled="isProcessing">Запустить обработку файлов</button>
                    <div class="progress" x-show="isProcessing">
                        <span class="spinner"></span> Обработка файлов запущена в фоновом режиме...
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Embedding Module -->
        <div id="embedding-module" class="module-content" x-show="activeTab === 'embedding'">
            <div class="module-card">
                <h3>Настройки эмбеддинга</h3>
                
                <form action="/api/admin/update-settings" method="post" class="settings-form" data-module="embedding" @submit="submitSettingsForm">
                    <input type="hidden" name="action" value="save_advanced_settings">
                    <input type="hidden" name="active_tab" value="embedding">
                    
                    <label for="hf_model">Модель для плотных векторов (семантика)</label>
                    <input list="model-history-dense" id="hf_model" name="hf_model" value="{{ config.current_hf_model }}" required>
                    <datalist id="model-history-dense">
                        {% for model in config.hf_model_history %}
                            <option value="{{ model }}">{{ model }}</option>
                        {% endfor %}
                    </datalist>
                    
                    <label for="sparse_embedding">Модель для sparse embedding</label>
                    <input type="text" id="sparse_embedding" name="sparse_embedding" value="{{ config.sparse_embedding }}" required>
                    
                    <div style="margin-top: 1rem;">
                        <input type="checkbox" id="use_bm25" name="use_bm25" value="True" 
                               {% if config.use_bm25 %}checked{% endif %}>
                        <label for="use_bm25">Включить native BM25 (IDF modifier)</label>
                    </div>
                    
                    <div class="grid-2col" style="margin-top: 1rem;">
                        <div>
                            <label for="sparse_vector_name">Имя sparse вектора</label>
                            <input type="text" id="sparse_vector_name" name="sparse_vector_name" value="{{ config.sparse_vector_name }}">
                        </div>
                        <div>
                            <label for="bm25_tokenizer">Токенизатор BM25</label>
                            <select id="bm25_tokenizer" name="bm25_tokenizer">
                                <option value="word" {% if config.bm25_tokenizer == 'word' %}selected{% endif %}>Word</option>
                                <option value="whitespace" {% if config.bm25_tokenizer == 'whitespace' %}selected{% endif %}>Whitespace</option>
                            </select>
                        </div>
                    </div>
                    
                    <label for="bm25_min_token_len">Минимальная длина токена для BM25</label>
                    <input type="number" id="bm25_min_token_len" name="bm25_min_token_len" value="{{ config.bm25_min_token_len }}" min="1" required>
                    
                    <div class="form-info">
                        <p><strong>Директория кэша моделей sparse embedding:</strong> 
                           <span id="fastembed_cache_dir_display">
                               {% if fastembed_cache_dir %}
                                   {{ fastembed_cache_dir }}
                               {% else %}
                                   Не задана (используется директория по умолчанию)
                               {% endif %}
                           </span>
                        </p>
                        <p class="help-text">
                            Директория кэша моделей BM25 и других sparse моделей задается через переменную окружения FASTEMBED_CACHE_DIR в файле .env.
                        </p>
                    </div>
                    
                    <button type="submit" :disabled="isProcessing">Сохранить настройки эмбеддинга</button>
                    <div class="progress" x-show="isProcessing">
                        <span class="spinner"></span> Сохранение настроек эмбеддинга...
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Search Module -->
        <div id="search-module" class="module-content" x-show="activeTab === 'search'">
            <div class="module-card">
                <h3>Настройки поиска</h3>
                
                <form action="/api/admin/update-settings" method="post" class="settings-form" data-module="search" @submit="submitSettingsForm">
                    <input type="hidden" name="action" value="save_advanced_settings">
                    <input type="hidden" name="active_tab" value="search">
                    
                    <label for="search_default_k">Количество результатов поиска по умолчанию</label>
                    <input type="number" id="search_default_k" name="search_default_k" value="{{ config.search_default_k }}" min="1" required>
                    
                    <button type="submit" :disabled="isProcessing">Сохранить настройки поиска</button>
                    <div class="progress" x-show="isProcessing">
                        <span class="spinner"></span> Сохранение настроек поиска...
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Qdrant Module -->
        <div id="qdrant-module" class="module-content" x-show="activeTab === 'qdrant'">
            <div class="module-card">
                <h3>Настройки подключения к Qdrant</h3>
                
                <form action="/api/admin/update-settings" method="post" class="settings-form" data-module="qdrant" @submit="submitSettingsForm">
                    <input type="hidden" name="action" value="save_advanced_settings">
                    <input type="hidden" name="active_tab" value="qdrant">
                    
                    <label for="qdrant_url">URL Qdrant</label>
                    <input type="text" id="qdrant_url" name="qdrant_url" value="{{ config.qdrant_url }}" required>
                    
                    <div class="grid-2col">
                        <div>
                            <label for="qdrant_retry_attempts">Количество попыток повтора</label>
                            <input type="number" id="qdrant_retry_attempts" name="qdrant_retry_attempts" value="{{ config.qdrant_retry_attempts }}" min="1" required>
                        </div>
                        <div>
                            <label for="qdrant_retry_wait_time">Время ожидания между попытками (сек)</label>
                            <input type="number" id="qdrant_retry_wait_time" name="qdrant_retry_wait_time" value="{{ config.qdrant_retry_wait_time }}" min="1" required>
                        </div>
                    </div>
                    
                    <button type="submit">Сохранить настройки Qdrant</button>
                    <div class="progress">
                        <span class="spinner"></span> Сохранение настроек Qdrant...
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Collections Module -->
        <div id="collections-module" class="module-content" x-show="activeTab === 'collections'">
            <div class="module-card">
                <h3>Управление коллекциями</h3>
                
                <form action="/api/admin/settings/delete-collection" method="post" class="action-form" data-action="delete-collection">
                    <label for="collection_to_delete">Удалить коллекцию:
                        <select id="collection_to_delete" name="collection_name" required>
                            <option value="">-- Выберите коллекцию --</option>
                            {% for c in collections %}
                                <option value="{{ c }}">{{ c }}</option>
                            {% endfor %}
                        </select>
                    </label>
                    <button type="submit" onclick="return confirm('Вы уверены, что хотите удалить выбранную коллекцию? Это действие необратимо.');" :disabled="isProcessing">Удалить</button>
                    <div class="progress" x-show="isProcessing">
                        <span class="spinner"></span> Удаление коллекции...
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Advanced Module -->
        <div id="advanced-module" class="module-content" x-show="activeTab === 'advanced'">
            <div class="module-card">
                <h3>Настройки кэширования</h3>
                
                <form action="/api/admin/update-settings" method="post" class="settings-form" data-module="advanced" @submit="submitSettingsForm">
                    <input type="hidden" name="action" value="save_advanced_settings">
                    
                    <div class="grid-3col">
                        <div>
                            <label for="config_cache_ttl">TTL кэша конфигурации (сек)</label>
                            <input type="number" id="config_cache_ttl" name="config_cache_ttl" value="{{ config.config_cache_ttl }}" min="1" required>
                        </div>
                        <div>
                            <label for="qdrant_client_cache_ttl">TTL кэша клиента Qdrant (сек)</label>
                            <input type="number" id="qdrant_client_cache_ttl" name="qdrant_client_cache_ttl" value="{{ config.qdrant_client_cache_ttl }}" min="1" required>
                        </div>
                        <div>
                            <label for="collections_cache_ttl">TTL кэша коллекций (сек)</label>
                            <input type="number" id="collections_cache_ttl" name="collections_cache_ttl" value="{{ config.collections_cache_ttl }}" min="1" required>
                        </div>
                    </div>
                    
                    <button type="submit" :disabled="isProcessing">Сохранить настройки кэширования</button>
                    <div class="progress" x-show="isProcessing">
                        <span class="spinner"></span> Сохранение настроек кэширования...
                    </div>
                </form>
            </div>
            
            <div class="module-card">
                <h3>Настройки GGUF моделей</h3>
                
                <form action="/api/admin/update-settings" method="post" class="settings-form" data-module="advanced" @submit="submitSettingsForm">
                    <input type="hidden" name="action" value="save_advanced_settings">
                    <input type="hidden" name="active_tab" value="advanced">
                    
                    <label for="gguf_model_n_ctx">Размер контекста для GGUF моделей</label>
                    <input type="number" id="gguf_model_n_ctx" name="gguf_model_n_ctx" value="{{ config.gguf_model_n_ctx }}" min="1" required>
                    
                    <button type="submit">Сохранить настройки GGUF</button>
                    <div class="progress">
                        <span class="spinner"></span> Сохранение настроек GGUF...
                    </div>
                </form>
            </div>
            
            <div class="module-card">
                <h3>Настройки индексации документов</h3>
                
                <form action="/api/admin/update-settings" method="post" class="settings-form" data-module="advanced" @submit="submitSettingsForm">
                    <input type="hidden" name="action" value="save_advanced_settings">
                    <input type="hidden" name="active_tab" value="advanced">
                    
                    <div class="grid-2col">
                        <div>
                            <label for="memory_threshold">Порог памяти (байт)</label>
                            <input type="number" id="memory_threshold" name="memory_threshold" value="{{ config.memory_threshold }}" min="1" required>
                        </div>
                        <div>
                            <label for="indexing_default_batch_size">Размер батча по умолчанию</label>
                            <input type="number" id="indexing_default_batch_size" name="indexing_default_batch_size" value="{{ config.indexing_default_batch_size }}" min="1" required>
                        </div>
                    </div>
                    
                    <button type="submit" :disabled="isProcessing">Сохранить настройки индексации документов</button>
                    <div class="progress" x-show="isProcessing">
                        <span class="spinner"></span> Сохранение настроек индексации документов...
                    </div>
                </form>
            </div>
            
            <h3>Настройки MinerU (дополнительные)</h3>
                
                <form action="/api/admin/update-settings" method="post" class="settings-form" data-module="advanced" @submit="submitSettingsForm">
                    <input type="hidden" name="action" value="save_advanced_settings">
                    <input type="hidden" name="active_tab" value="advanced">
                    
                    <label for="mineru_subprocess_timeout">Таймаут subprocess вызова mineru (сек)</label>
                    <input type="number" id="mineru_subprocess_timeout" name="mineru_subprocess_timeout" value="{{ config.mineru_subprocess_timeout }}" min="1" required>
                    
                    <button type="submit" :disabled="isProcessing">Сохранить дополнительные настройки MinerU</button>
                    <div class="progress" x-show="isProcessing">
                        <span class="spinner"></span> Сохранение дополнительных настроек MinerU...
                    </div>
                </form>
            </div>
            
            <div class="module-card">
                <h3>Информация о переменных окружения</h3>
                
                <div class="form-info">
                    <p><strong>Переменные окружения:</strong> Некоторые настройки задаются через переменные окружения в файле <code>.env</code>:</p>
                    <ul>
                        <li><code>ADMIN_API_KEY</code> - API ключ для защиты админки</li>
                        <li><code>HUGGINGFACE_TOKEN</code> - Токен HuggingFace для приватных моделей</li>
                        <li><code>FASTEMBED_CACHE_DIR</code> - Директория кэша моделей BM25 (по умолчанию <code>./models/fastembed_cache</code>)</li>
                    </ul>
                </div>
            </div>
        </div>
        
        <!-- Reranker Module -->
        <div id="reranker-module" class="module-content" x-show="activeTab === 'reranker'">
            <div class="module-card">
                <h3>Настройки Reranker</h3>
                
                <form action="/api/admin/update-settings" method="post" class="settings-form" data-module="reranker" @submit="submitSettingsForm">
                    <input type="hidden" name="action" value="save_advanced_settings">
                    <input type="hidden" name="active_tab" value="reranker">
                    
                    <div style="margin-bottom: 1rem;">
                        <input type="checkbox" id="reranker_enabled" name="reranker_enabled" value="True" 
                               {% if config.reranker_enabled %}checked{% endif %}>
                        <label for="reranker_enabled">Включить reranker</label>
                    </div>
                    
                    <label for="reranker_model">Модель reranker</label>
                    <input type="text" id="reranker_model" name="reranker_model" value="{{ config.reranker_model }}" required>
                    
                    <label for="reranker_top_k">Количество результатов после reranking</label>
                    <input type="number" id="reranker_top_k" name="reranker_top_k" value="{{ config.reranker_top_k }}" min="1" required>
                    
                    <div class="form-info">
                        <p><strong>Поддерживаемые модели:</strong></p>
                        <ul>
                            <li><code>cross-encoder/ms-marco-MiniLM-L-6-v2</code> - Быстрая и эффективная модель</li>
                            <li><code>cross-encoder/ms-marco-TinyBERT-L-6</code> - Более компактная модель</li>
                            <li><code>models/reranker_model.gguf</code> - Локальная модель в формате GGUF</li>
                        </ul>
                        <p class="help-text">
                            Модели загружаются автоматически при первом использовании и кэшируются локально. 
                            Локальные модели должны быть в формате GGUF и доступны по указанному пути.
                        </p>
                    </div>
                    
                    <button type="submit" :disabled="isProcessing">Сохранить настройки reranker</button>
                    <div class="progress" x-show="isProcessing">
                        <span class="spinner"></span> Сохранение настроек reranker...
                    </div>
                </form>
            </div>
        </div>
    </div>
    </main>
</body>
</html>