
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Настройки</title>
    <link rel="stylesheet" href="/static/simple.min.css">
    <style>
        .status-msg { padding: 1rem; margin-bottom: 1rem; border-radius: 4px; }
        .success { background-color: #d4edda; color: #155724; }
        .info { background-color: #cce5ff; color: #004085; }
        .error { background-color: #f8d7da; color: #721c24; }
        fieldset { margin-top: 1rem; }
        legend { font-weight: bold; }
        .grid-2col { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
        .grid-3col { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem; }
        .grid-4col { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 1rem; }
        .form-section { border: 1px solid #ccc; border-radius: 4px; padding: 1rem; margin-bottom: 1rem; }
        .form-section h3 { margin-top: 0; }
        .progress { display: none; padding: 1rem; margin: 1rem 0; background-color: #f0f0f0; border-radius: 4px; }
        .spinner { display: inline-block; width: 20px; height: 20px; border: 3px solid #f3f3f3; border-top: 3px solid #3498db; border-radius: 50%; animation: spin 1s linear infinite; margin-right: 10px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .collapsible { cursor: pointer; padding: 10px; background-color: #f1f1f1; border: none; text-align: left; outline: none; }
        .content { padding: 0 18px; display: none; overflow: hidden; background-color: #f9f9f9; }
        .form-info { background-color: #e9ecef; padding: 1rem; border-radius: 4px; margin-bottom: 1rem; }
        .form-info p { margin: 0 0 0.5rem 0; }
        .form-info ul { margin: 0.5rem 0; padding-left: 1.5rem; }
        .help-text { font-size: 0.9em; color: #6c757d; margin: 0.5rem 0 0 0; }
        #error-message { display: none; color: red; padding: 1rem; background-color: #f8d7da; border: 1px solid #f5c6cb; border-radius: 4px; margin: 1rem 0; }
        #success-message { display: none; color: green; padding: 1rem; background-color: #d4edda; border: 1px solid #c3e6cb; border-radius: 4px; margin: 1rem 0; }
    </style>
</head>
<body>
    <header>
        <h1>Настройки и Управление</h1>
        <nav><a href="/">Поиск</a> <a href="/settings/">Настройки</a></nav>
    </header>
    <main>
        {% if status or delete_status %}
            {% set msg = status or delete_status %}
            <div class="status-msg {{ 'success' if 'success' in msg or 'saved' in msg or 'indexed' in msg or 'deleted_' in msg or 'pdfs_processed' in msg or 'files_processed' in msg else 'error' if 'error' in msg or 'fail' in msg or 'no_index_type' in msg or 'delete_error' in msg or 'pdf_processing_error' in msg or 'file_processing_error' in msg else 'info' }}">
                {% if msg == 'saved' %}Настройки сохранены.{% endif %}
                {% if msg == 'indexed_successfully' %}Индексация успешно завершена!{% endif %}
                {% if msg == 'indexed_successfully_no_docs' %}Индексация завершена. Не найдено .txt/.md файлов для обработки.{% endif %}
                {% if 'error' in msg or 'fail' in msg or 'no_index_type' in msg %}Ошибка индексации. Проверьте логи терминала. Сообщение: {{ msg }}{% endif %}
                {% if 'deleted_' in msg and not 'delete_error' in msg %}Коллекция успешно удалена.{% endif %}
                {% if 'delete_error' in msg %}Ошибка при удалении коллекции: {{ msg.split('delete_error_')[-1].replace('_', ' ') }}{% endif %}
                {% if msg == 'error_no_collection_selected' %}Ошибка: Не выбрана коллекция для удаления.{% endif %}
                {% if 'pdfs_processed_successfully' in msg %}PDF файлы успешно обработаны!{% endif %}
                {% if 'pdf_processing_error' in msg %}Ошибка при обработке PDF. Проверьте логи терминала. Сообщение: {{ msg }}{% endif %}
                {% if 'files_processed_successfully' in msg %}Файлы успешно обработаны!{% endif %}
                {% if 'file_processing_error' in msg %}Ошибка при обработке файлов. Проверьте логи терминала. Сообщение: {{ msg }}{% endif %}
                {% if msg == 'indexing_started' %}Индексация запущена в фоновом режиме.{% endif %}
                {% if msg == 'processing_started' %}Обработка запущена в фоновом режиме.{% endif %}
            </div>
        {% endif %}
        
        <!-- Сообщения об ошибках и успехах -->
        <div id="error-message"></div>
        <div id="success-message"></div>
        
        <!-- Объединенная форма -->
        <form action="/api/admin/update-settings" method="post">
            <input type="hidden" name="action" value="save_index_settings"> <!-- Значение по умолчанию, будет перезаписано JS или кнопкой -->
            
            <!-- Секция настроек индексации -->
            <div class="form-section">
                <h3>Настройки индексации</h3>
                
                <label for="folder_path">Папка для индексации (TXT и MD файлы)</label>
                <input type="text" id="folder_path" name="folder_path" value="{{ config.folder_path }}" required>
                
                <label for="collection_name">Имя новой коллекции</label>
                <input type="text" id="collection_name" name="collection_name" value="{{ config.collection_name }}" required>
                
                <label for="hf_model">Модель для плотных векторов (семантика)</label>
                <input list="model-history-dense" id="hf_model" name="hf_model" value="{{ config.current_hf_model }}" required>
                <datalist id="model-history-dense">
                    {% for model in config.hf_model_history %}
                        <option value="{{ model }}">{{ model }}</option>
                    {% endfor %}
                </datalist>
                
                <div class="grid-2col">
                    <div>
                        <label for="chunk_size">Размер чанка</label>
                        <input type="number" id="chunk_size" name="chunk_size" value="{{ config.chunk_size }}" required>
                    </div>
                    <div>
                        <label for="chunk_overlap">Перекрытие чанков</label>
                        <input type="number" id="chunk_overlap" name="chunk_overlap" value="{{ config.chunk_overlap }}" required>
                    </div>
                </div>
                <div class="grid-2col">
                    <div>
                        <label for="embedding_batch_size">Batch size для эмбеддинга (HuggingFace)</label>
                        <input type="number" id="embedding_batch_size" name="embedding_batch_size" value="{{ config.embedding_batch_size }}" min="1" required>
                    </div>
                    <div>
                        <label for="indexing_batch_size">Batch size для индексации (Qdrant)</label>
                        <input type="number" id="indexing_batch_size" name="indexing_batch_size" value="{{ config.indexing_batch_size }}" min="1" required>
                    </div>
                </div>
                
                <fieldset>
                    <legend>Типы векторов для индексации</legend>
                    <input type="radio" id="indexing_dense" name="indexing_type" value="dense" {% if config.index_dense and not config.index_hybrid %}checked{% endif %}>
                    <label for="indexing_dense">Плотные векторы (dense)</label><br>
                    <input type="radio" id="indexing_sparse" name="indexing_type" value="sparse" {% if config.index_bm25 and not config.index_hybrid %}checked{% endif %}>
                    <label for="indexing_sparse">Разреженные векторы (BM25)</label><br>
                    <input type="radio" id="indexing_hybrid" name="indexing_type" value="hybrid" {% if config.index_hybrid %}checked{% endif %}>
                    <label for="indexing_hybrid">Гибридный режим (dense + BM25)</label><br>
                    <!-- Hidden fields to store individual flags -->
                    <input type="hidden" id="index_dense" name="index_dense" value="{{ 'True' if config.index_dense else 'False' }}">
                    <input type="hidden" id="index_bm25" name="index_bm25" value="{{ 'True' if config.index_bm25 else 'False' }}">
                    <input type="hidden" id="index_hybrid" name="index_hybrid" value="{{ 'True' if config.index_hybrid else 'False' }}">
                    <!-- Legacy fields kept for compatibility -->
                    <input type="hidden" id="use_dense" name="use_dense" value="{{ 'True' if config.use_dense_vectors else 'False' }}">
                    <input type="hidden" id="use_hybrid" name="use_hybrid" value="{{ 'True' if config.use_hybrid else 'False' }}">
                </fieldset>
                
                <script>
                    // Обработчики событий для радиокнопок индексации
                    document.getElementById('indexing_dense').addEventListener('change', function() {
                        if (this.checked) {
                            document.getElementById('index_dense').value = 'True';
                            document.getElementById('index_bm25').value = 'False';
                            document.getElementById('index_hybrid').value = 'False';
                        }
                    });
                    
                    document.getElementById('indexing_sparse').addEventListener('change', function() {
                        if (this.checked) {
                            document.getElementById('index_dense').value = 'False';
                            document.getElementById('index_bm25').value = 'True';
                            document.getElementById('index_hybrid').value = 'False';
                        }
                    });
                    
                    document.getElementById('indexing_hybrid').addEventListener('change', function() {
                        if (this.checked) {
                            document.getElementById('index_dense').value = 'True';
                            document.getElementById('index_bm25').value = 'True';  // Гибрид подразумевает sparse
                            document.getElementById('index_hybrid').value = 'True';
                        }
                    });
                </script>
                
                <fieldset>
                    <legend>Устройство для индексации</legend>
                    <input type="radio" id="dev_auto" name="device" value="auto" {% if config.device == 'auto' %}checked{% endif %}>
                    <label for="dev_auto">Авто</label>
                    <input type="radio" id="dev_cuda" name="device" value="cuda" {% if config.device == 'cuda' %}checked{% endif %}>
                    <label for="dev_cuda">GPU</label>
                    <input type="radio" id="dev_cpu" name="device" value="cpu" {% if config.device == 'cpu' %}checked{% endif %}>
                    <label for="dev_cpu">CPU</label>
                </fieldset>
                
                <button type="submit" name="action" value="save_index_settings">Сохранить настройки индексации</button>
                <div id="index-settings-progress" class="progress">
                    <span class="spinner"></span> Сохранение настроек индексации...
                </div>
            </div>
        </form>
        
        <form action="/api/admin/update-settings" method="post">
            <input type="hidden" name="action" value="save_mineru_settings"> <!-- Значение по умолчанию -->
            
            <!-- Секция настроек MinerU -->
            <div class="form-section">
                <h3>Настройки обработки PDF (MinerU - Subprocess)</h3>
                <p><strong>Важно:</strong> Убедитесь, что пакет `mineru` установлен и команда `mineru` доступна в вашем окружении.</p>
                
                <label for="mineru_input_pdf_dir">Папка с PDF файлами для обработки</label>
                <input type="text" id="mineru_input_pdf_dir" name="mineru_input_pdf_dir" value="{{ config.mineru_input_pdf_dir }}" required>
                
                <label for="mineru_output_md_dir">Папка для сохранения Markdown файлов (вход для индексации)</label>
                <input type="text" id="mineru_output_md_dir" name="mineru_output_md_dir" value="{{ config.mineru_output_md_dir }}" required>
                
                <div class="grid-3col">
                    <div>
                        <input type="checkbox" id="mineru_enable_formula_parsing" name="mineru_enable_formula_parsing" value="True" {% if config.mineru_enable_formula_parsing %}checked{% endif %}>
                        <label for="mineru_enable_formula_parsing">Парсинг формул</label>
                    </div>
                    <div>
                        <input type="checkbox" id="mineru_enable_table_parsing" name="mineru_enable_table_parsing" value="True" {% if config.mineru_enable_table_parsing %}checked{% endif %}>
                        <label for="mineru_enable_table_parsing">Парсинг таблиц</label>
                    </div>
                    <div>
                        <!-- Можно добавить другие опции, если понадобятся -->
                    </div>
                </div>
                
                <div class="grid-2col">
                    <div>
                        <label for="mineru_backend">Бэкенд обработки</label>
                        <select id="mineru_backend" name="mineru_backend" required>
                            <option value="pipeline" {% if config.mineru_backend == 'pipeline' %}selected{% endif %}>Pipeline</option>
                            <option value="vlm-transformers" {% if config.mineru_backend == 'vlm-transformers' %}selected{% endif %}>VLM Transformers</option>
                            <option value="vlm-sglang-client" {% if config.mineru_backend == 'vlm-sglang-client' %}selected{% endif %}>VLM SGLang Client</option>
                        </select>
                    </div>
                    <div>
                        <label for="mineru_method">Метод парсинга</label>
                        <select id="mineru_method" name="mineru_method" required>
                            <option value="auto" {% if config.mineru_method == 'auto' %}selected{% endif %}>Auto</option>
                            <option value="txt" {% if config.mineru_method == 'txt' %}selected{% endif %}>TXT</option>
                            <option value="ocr" {% if config.mineru_method == 'ocr' %}selected{% endif %}>OCR</option>
                        </select>
                    </div>
                </div>
                
                <div class="grid-2col">
                    <div>
                        <label for="mineru_lang">Язык для OCR</label>
                        <input type="text" id="mineru_lang" name="mineru_lang" value="{{ config.mineru_lang }}" required>
                    </div>
                    <div>
                        <label for="mineru_sglang_url">URL сервера SGLang (если backend=VLM SGLang Client)</label>
                        <input type="text" id="mineru_sglang_url" name="mineru_sglang_url" value="{{ config.mineru_sglang_url }}">
                    </div>
                </div>

                <fieldset>
                    <legend>Источник моделей для MinerU</legend>
                    <input type="radio" id="ms_hf" name="mineru_model_source" value="huggingface" {% if config.mineru_model_source == 'huggingface' %}checked{% endif %}>
                    <label for="ms_hf">Hugging Face</label>
                    <input type="radio" id="ms_ms" name="mineru_model_source" value="modelscope" {% if config.mineru_model_source == 'modelscope' %}checked{% endif %}>
                    <label for="ms_ms">ModelScope</label>
                    <input type="radio" id="ms_local" name="mineru_model_source" value="local" {% if config.mineru_model_source == 'local' %}checked{% endif %}>
                    <label for="ms_local">Локальные модели</label>
                </fieldset>
                
                <label for="mineru_models_dir">Путь к локальным моделям (если выбрано 'Локальные модели')</label>
                <input type="text" id="mineru_models_dir" name="mineru_models_dir" value="{{ config.mineru_models_dir }}">

                <button type="submit" name="action" value="save_mineru_settings">Сохранить настройки MinerU</button>
                <div id="mineru-settings-progress" class="progress">
                    <span class="spinner"></span> Сохранение настроек MinerU...
                </div>
            </div>
        </form>
        
        <!-- Секция дополнительных настроек -->
        <button type="button" id="advanced-settings-button" onclick="toggleAdvancedSettings()">Дополнительные настройки</button>
        <div class="content" id="advanced-settings-content">
            <form action="/api/admin/update-settings" method="post">
                <input type="hidden" name="action" value="save_advanced_settings">
                
                <div class="form-info">
                    <p><strong>Переменные окружения:</strong> Некоторые настройки задаются через переменные окружения в файле <code>.env</code>:</p>
                    <ul>
                        <li><code>ADMIN_API_KEY</code> - API ключ для защиты админки</li>
                        <li><code>FASTEMBED_CACHE_DIR</code> - Директория кэша моделей BM25 (по умолчанию <code>./models/fastembed_cache</code>)</li>
                    </ul>
                </div>
                
                <div class="form-section">
                    <h3>Настройки кэширования</h3>
                    
                    <div class="grid-3col">
                        <div>
                            <label for="config_cache_ttl">TTL кэша конфигурации (сек)</label>
                            <input type="number" id="config_cache_ttl" name="config_cache_ttl" value="{{ config.config_cache_ttl }}" min="1" required>
                        </div>
                        <div>
                            <label for="qdrant_client_cache_ttl">TTL кэша клиента Qdrant (сек)</label>
                            <input type="number" id="qdrant_client_cache_ttl" name="qdrant_client_cache_ttl" value="{{ config.qdrant_client_cache_ttl }}" min="1" required>
                        </div>
                        <div>
                            <label for="collections_cache_ttl">TTL кэша коллекций (сек)</label>
                            <input type="number" id="collections_cache_ttl" name="collections_cache_ttl" value="{{ config.collections_cache_ttl }}" min="1" required>
                        </div>
                    </div>
                </div>
                
                <div class="form-section">
                    <h3>Настройки GGUF моделей</h3>
                    
                    <label for="gguf_model_n_ctx">Размер контекста для GGUF моделей</label>
                    <input type="number" id="gguf_model_n_ctx" name="gguf_model_n_ctx" value="{{ config.gguf_model_n_ctx }}" min="1" required>
                </div>
                
                <div class="form-section">
                    <h3>Настройки поиска</h3>
                    
                    <label for="search_default_k">Количество результатов поиска по умолчанию</label>
                    <input type="number" id="search_default_k" name="search_default_k" value="{{ config.search_default_k }}" min="1" required>
                </div>
                
                <div class="form-section">
                    <h3>Настройки подключения к Qdrant</h3>
                    
                    <div class="grid-2col">
                        <div>
                            <label for="qdrant_url">URL Qdrant</label>
                            <input type="text" id="qdrant_url" name="qdrant_url" value="{{ config.qdrant_url }}" required>
                        </div>
                        <div>
                            <label for="qdrant_retry_attempts">Количество попыток повтора</label>
                            <input type="number" id="qdrant_retry_attempts" name="qdrant_retry_attempts" value="{{ config.qdrant_retry_attempts }}" min="1" required>
                        </div>
                    </div>
                    
                    <label for="qdrant_retry_wait_time">Время ожидания между попытками (сек)</label>
                    <input type="number" id="qdrant_retry_wait_time" name="qdrant_retry_wait_time" value="{{ config.qdrant_retry_wait_time }}" min="1" required>
                </div>
                
                <div class="form-section">
                    <h3>Настройки индексации документов</h3>
                    
                    <div class="grid-2col">
                        <div>
                            <label for="memory_threshold">Порог памяти (байт)</label>
                            <input type="number" id="memory_threshold" name="memory_threshold" value="{{ config.memory_threshold }}" min="1" required>
                        </div>
                        <div>
                            <label for="indexing_default_batch_size">Размер батча по умолчанию</label>
                            <input type="number" id="indexing_default_batch_size" name="indexing_default_batch_size" value="{{ config.indexing_default_batch_size }}" min="1" required>
                        </div>
                    </div>
                    
                    <label for="sparse_embedding">Модель для sparse embedding</label>
                    <input type="text" id="sparse_embedding" name="sparse_embedding" value="{{ config.sparse_embedding }}" required>
                    
                    <div class="form-info">
                        <p><strong>Директория кэша моделей sparse embedding:</strong> 
                           <span id="fastembed_cache_dir_display">
                               {% if fastembed_cache_dir %}
                                   {{ fastembed_cache_dir }}
                               {% else %}
                                   Не задана (используется директория по умолчанию)
                               {% endif %}
                           </span>
                        </p>
                        <p class="help-text">
                            Директория кэша моделей BM25 и других sparse моделей задается через переменную окружения FASTEMBED_CACHE_DIR в файле .env.
                        </p>
                    </div>
                </div>
                
                <div class="form-section">
                    <h3>Настройки MinerU (дополнительные)</h3>
                    
                    <label for="mineru_subprocess_timeout">Таймаут subprocess вызова mineru (сек)</label>
                    <input type="number" id="mineru_subprocess_timeout" name="mineru_subprocess_timeout" value="{{ config.mineru_subprocess_timeout }}" min="1" required>
                </div>
                
                <button type="submit" name="action" value="save_advanced_settings">Сохранить дополнительные настройки</button>
                <div id="advanced-settings-progress" class="progress">
                    <span class="spinner"></span> Сохранение дополнительных настроек...
                </div>
            </form>
        </div>
        
        <hr>
        
        <h2>Управление коллекциями</h2>
        <form action="/api/admin/settings/delete-collection" method="post">
             <label for="collection_to_delete">Удалить коллекцию:
                <select id="collection_to_delete" name="collection_name" required>
                    <option value="">-- Выберите коллекцию --</option>
                    {% for c in collections %}
                        <option value="{{ c }}">{{ c }}</option>
                    {% endfor %}
                </select>
            </label>
            <button type="submit" onclick="return confirm('Вы уверены, что хотите удалить выбранную коллекцию? Это действие необратимо.');">Удалить</button>
        </form>
        
        <hr>
        
        <h2>Управление данными</h2>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
            <div>
                <h3>Обработка PDF</h3>
                <p>Преобразовать PDF из <strong>{{ config.mineru_input_pdf_dir }}</strong> в Markdown и сохранить в <strong>{{ config.mineru_output_md_dir }}</strong>.</p>
                <form action="/api/admin/process-pdfs" method="post" id="process-pdfs-form" onsubmit="handleProcessPdfsSubmit()">
                    <button type="submit" id="process-pdfs-btn">Запустить обработку PDF (Subprocess)</button>
                </form>
                <div id="process-pdfs-progress" class="progress">
                    <span class="spinner"></span> Обработка PDF запущена в фоновом режиме...
                </div>

                <h3>Обработка файлов различных форматов</h3>
                <p>Преобразовать файлы различных форматов из <strong>{{ config.mineru_input_pdf_dir }}</strong> в Markdown и сохранить в <strong>{{ config.mineru_output_md_dir }}</strong>.</p>
                <form action="/api/admin/process-files" method="post" id="process-files-form" onsubmit="handleProcessFilesSubmit()">
                    <button type="submit" id="process-files-btn">Запустить обработку файлов</button>
                </form>
                <div id="process-files-progress" class="progress">
                    <span class="spinner"></span> Обработка файлов запущена в фоновом режиме...
                </div>
            </div>
            <div>
                <h3>Управление индексом</h3>
                <p>Проиндексировать данные из <strong>{{ config.folder_path }}</strong> в коллекцию <strong>{{ config.collection_name }}</strong>.</p>
                <form action="/api/admin/run-indexing" method="post" id="run-indexing-form" onsubmit="handleRunIndexingSubmit()">
                    <button type="submit" id="run-indexing-btn">Запустить индексацию</button>
                </form>
                <div id="run-indexing-progress" class="progress">
                    <span class="spinner"></span> Индексация запущена в фоновом режиме...
                </div>
            </div>
        </div>
    </main>
    
    <script>
        // Функция для выполнения AJAX POST запроса
        async function ajaxPost(url, data) {
            const formData = new FormData();
            for (const key in data) {
                if (data.hasOwnProperty(key)) {
                    formData.append(key, data[key]);
                }
            }
            
            const response = await fetch(url, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            });
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const contentType = response.headers.get('content-type');
            if (contentType && contentType.includes('application/json')) {
                return await response.json();
            } else {
                return await response.text();
            }
        }
        
        // Функция для отображения сообщения об ошибке
        function showErrorMessage(message) {
            const errorContainer = document.getElementById('error-message');
            if (errorContainer) {
                errorContainer.textContent = message;
                errorContainer.style.display = 'block';
            }
        }
        
        // Функция для скрытия сообщения об ошибке
        function hideErrorMessage() {
            const errorContainer = document.getElementById('error-message');
            if (errorContainer) {
                errorContainer.style.display = 'none';
            }
        }
        
        // Функция для отображения сообщения об успехе
        function showSuccessMessage(message) {
            const successContainer = document.getElementById('success-message');
            if (successContainer) {
                successContainer.textContent = message;
                successContainer.style.display = 'block';
            }
        }
        
        // Функция для скрытия сообщения об успехе
        function hideSuccessMessage() {
            const successContainer = document.getElementById('success-message');
            if (successContainer) {
                successContainer.style.display = 'none';
            }
        }
        
        // Функция для отображения индикатора загрузки
        function showLoadingIndicator(elementId) {
            const loadingIndicator = document.getElementById(elementId);
            if (loadingIndicator) {
                loadingIndicator.style.display = 'block';
            }
        }
        
        // Функция для скрытия индикатора загрузки
        function hideLoadingIndicator(elementId) {
            const loadingIndicator = document.getElementById(elementId);
            if (loadingIndicator) {
                loadingIndicator.style.display = 'none';
            }
        }
        
        // Обработчики событий для форм с индикаторами прогресса
        function handleProcessPdfsSubmit() {
            try {
                document.getElementById('process-pdfs-btn').disabled = true;
                document.getElementById('process-pdfs-progress').style.display = 'block';
            } catch (e) {
                console.log("Error in handleProcessPdfsSubmit:", e);
            }
        }
        
        function handleRunIndexingSubmit() {
            try {
                document.getElementById('run-indexing-btn').disabled = true;
                document.getElementById('run-indexing-progress').style.display = 'block';
            } catch (e) {
                console.log("Error in handleRunIndexingSubmit:", e);
            }
        }
        
        function handleProcessFilesSubmit() {
            try {
                document.getElementById('process-files-btn').disabled = true;
                document.getElementById('process-files-progress').style.display = 'block';
            } catch (e) {
                console.log("Error in handleProcessFilesSubmit:", e);
            }
        }
        
        // Простой обработчик для кнопки дополнительных настроек
        function toggleAdvancedSettings() {
            try {
                var button = document.getElementById('advanced-settings-button');
                var content = document.getElementById('advanced-settings-content');
                
                if (button && content) {
                    button.classList.toggle("active");
                    if (content.style.display === "block") {
                        content.style.display = "none";
                    } else {
                        content.style.display = "block";
                    }
                }
            } catch (e) {
                console.log("Error in toggleAdvancedSettings:", e);
            }
        }
        
        // Простой обработчик для чекбокса index_hybrid
        function setupIndexHybridHandler() {
            try {
                var checkbox = document.getElementById('index_hybrid');
                if (checkbox) {
                    checkbox.addEventListener('change', function() {
                        if (this.checked) {
                            document.getElementById('index_dense').checked = true;
                        }
                    });
                }
            } catch (e) {
                console.log("Error setting up index_hybrid handler:", e);
            }
        }
        
        // Обработчик для формы удаления коллекции
        async function handleDeleteCollectionSubmit(event) {
            event.preventDefault();
            
            // Скрываем сообщения
            hideErrorMessage();
            hideSuccessMessage();
            
            const collectionName = document.getElementById('collection_to_delete').value;
            if (!collectionName) {
                showErrorMessage('Пожалуйста, выберите коллекцию для удаления.');
                return;
            }
            
            try {
                const response = await ajaxPost('/api/admin/settings/delete-collection', {
                    collection_name: collectionName
                });
                
                if (response.status && response.status.includes('deleted_')) {
                    showSuccessMessage('Коллекция успешно удалена.');
                    // Обновляем список коллекций
                    location.reload();
                } else if (response.status === 'delete_error') {
                    showErrorMessage('Ошибка при удалении коллекции.');
                } else if (response.status === 'error_no_collection_selected') {
                    showErrorMessage('Не выбрана коллекция для удаления.');
                } else {
                    showErrorMessage('Произошла неизвестная ошибка.');
                }
            } catch (error) {
                console.error('Ошибка при удалении коллекции:', error);
                showErrorMessage('Произошла ошибка при удалении коллекции. Пожалуйста, попробуйте еще раз.');
            }
        }
        
        // Обработчик для формы настроек индексации
        async function handleIndexSettingsSubmit(event) {
            event.preventDefault();
            
            // Скрываем сообщения
            hideErrorMessage();
            hideSuccessMessage();
            
            // Отображаем индикатор загрузки
            showLoadingIndicator('index-settings-progress');
            
            // Собираем данные формы
            const formData = new FormData(event.target);
            formData.append('action', 'save_index_settings');
            
            try {
                const response = await ajaxPost('/api/admin/update-settings', Object.fromEntries(formData));
                
                if (response.status === 'saved') {
                    showSuccessMessage('Настройки индексации успешно сохранены.');
                } else {
                    showErrorMessage('Ошибка при сохранении настроек индексации.');
                }
            } catch (error) {
                console.error('Ошибка при сохранении настроек индексации:', error);
                showErrorMessage('Произошла ошибка при сохранении настроек индексации. Пожалуйста, попробуйте еще раз.');
            } finally {
                // Скрываем индикатор загрузки
                hideLoadingIndicator('index-settings-progress');
            }
        }
        
        // Обработчик для формы настроек MinerU
        async function handleMineruSettingsSubmit(event) {
            event.preventDefault();
            
            // Скрываем сообщения
            hideErrorMessage();
            hideSuccessMessage();
            
            // Отображаем индикатор загрузки
            showLoadingIndicator('mineru-settings-progress');
            
            // Собираем данные формы
            const formData = new FormData(event.target);
            formData.append('action', 'save_mineru_settings');
            
            try {
                const response = await ajaxPost('/api/admin/update-settings', Object.fromEntries(formData));
                
                if (response.status === 'saved') {
                    showSuccessMessage('Настройки MinerU успешно сохранены.');
                } else {
                    showErrorMessage('Ошибка при сохранении настроек MinerU.');
                }
            } catch (error) {
                console.error('Ошибка при сохранении настроек MinerU:', error);
                showErrorMessage('Произошла ошибка при сохранении настроек MinerU. Пожалуйста, попробуйте еще раз.');
            } finally {
                // Скрываем индикатор загрузки
                hideLoadingIndicator('mineru-settings-progress');
            }
        }
        
        // Обработчик для формы дополнительных настроек
        async function handleAdvancedSettingsSubmit(event) {
            event.preventDefault();
            
            // Скрываем сообщения
            hideErrorMessage();
            hideSuccessMessage();
            
            // Отображаем индикатор загрузки
            showLoadingIndicator('advanced-settings-progress');
            
            // Собираем данные формы
            const formData = new FormData(event.target);
            formData.append('action', 'save_advanced_settings');
            
            try {
                const response = await ajaxPost('/api/admin/update-settings', Object.fromEntries(formData));
                
                if (response.status === 'saved') {
                    showSuccessMessage('Дополнительные настройки успешно сохранены.');
                } else {
                    showErrorMessage('Ошибка при сохранении дополнительных настроек.');
                }
            } catch (error) {
                console.error('Ошибка при сохранении дополнительных настроек:', error);
                showErrorMessage('Произошла ошибка при сохранении дополнительных настроек. Пожалуйста, попробуйте еще раз.');
            } finally {
                // Скрываем индикатор загрузки
                hideLoadingIndicator('advanced-settings-progress');
            }
        }
        
        // Обработчик для формы индексации
        async function handleRunIndexingSubmit(event) {
            event.preventDefault();
            
            // Отображаем индикатор загрузки
            showLoadingIndicator('run-indexing-progress');
            
            try {
                const response = await ajaxPost('/api/admin/run-indexing', {});
                
                if (response.status === 'indexing_started') {
                    showSuccessMessage('Индексация запущена в фоновом режиме.');
                } else {
                    showErrorMessage('Ошибка при запуске индексации.');
                }
            } catch (error) {
                console.error('Ошибка при запуске индексации:', error);
                showErrorMessage('Произошла ошибка при запуске индексации. Пожалуйста, попробуйте еще раз.');
            } finally {
                // Скрываем индикатор загрузки
                hideLoadingIndicator('run-indexing-progress');
            }
        }
        
        // Обработчик для формы обработки PDF
        async function handleProcessPdfsSubmit(event) {
            event.preventDefault();
            
            // Отображаем индикатор загрузки
            showLoadingIndicator('process-pdfs-progress');
            
            try {
                const response = await ajaxPost('/api/admin/process-pdfs', {});
                
                if (response.status === 'processing_started') {
                    showSuccessMessage('Обработка PDF запущена в фоновом режиме.');
                } else {
                    showErrorMessage('Ошибка при запуске обработки PDF.');
                }
            } catch (error) {
                console.error('Ошибка при запуске обработки PDF:', error);
                showErrorMessage('Произошла ошибка при запуске обработки PDF. Пожалуйста, попробуйте еще раз.');
            } finally {
                // Скрываем индикатор загрузки
                hideLoadingIndicator('process-pdfs-progress');
            }
        }
        
        // Обработчик для формы обработки файлов
        async function handleProcessFilesSubmit(event) {
            event.preventDefault();
            
            // Отображаем индикатор загрузки
            showLoadingIndicator('process-files-progress');
            
            try {
                const response = await ajaxPost('/api/admin/process-files', {});
                
                if (response.status === 'processing_started') {
                    showSuccessMessage('Обработка файлов запущена в фоновом режиме.');
                } else {
                    showErrorMessage('Ошибка при запуске обработки файлов.');
                }
            } catch (error) {
                console.error('Ошибка при запуске обработки файлов:', error);
                showErrorMessage('Произошла ошибка при запуске обработки файлов. Пожалуйста, попробуйте еще раз.');
            } finally {
                // Скрываем индикатор загрузки
                hideLoadingIndicator('process-files-progress');
            }
        }
        
        // Инициализация обработчиков после загрузки DOM
        document.addEventListener('DOMContentLoaded', function() {
            setupIndexHybridHandler();
            
            // Добавляем обработчики для форм настроек
            const indexSettingsForm = document.querySelector('form[action="/api/admin/update-settings"][method="post"]');
            if (indexSettingsForm) {
                indexSettingsForm.addEventListener('submit', handleIndexSettingsSubmit);
            }
            
            const mineruSettingsForm = document.querySelectorAll('form[action="/api/admin/update-settings"][method="post"]')[1];
            if (mineruSettingsForm) {
                mineruSettingsForm.addEventListener('submit', handleMineruSettingsSubmit);
            }
            
            const advancedSettingsForm = document.querySelector('#advanced-settings-content form');
            if (advancedSettingsForm) {
                advancedSettingsForm.addEventListener('submit', handleAdvancedSettingsSubmit);
            }
            
            // Добавляем обработчики для форм индексации и обработки файлов
            const runIndexingForm = document.getElementById('run-indexing-form');
            if (runIndexingForm) {
                runIndexingForm.addEventListener('submit', handleRunIndexingSubmit);
            }
            
            const processPdfsForm = document.getElementById('process-pdfs-form');
            if (processPdfsForm) {
                processPdfsForm.addEventListener('submit', handleProcessPdfsSubmit);
            }
            
            const processFilesForm = document.getElementById('process-files-form');
            if (processFilesForm) {
                processFilesForm.addEventListener('submit', handleProcessFilesSubmit);
            }
            
            // Добавляем обработчик для формы удаления коллекции
            const deleteCollectionForm = document.querySelector('form[action="/api/admin/settings/delete-collection"]');
            if (deleteCollectionForm) {
                deleteCollectionForm.addEventListener('submit', handleDeleteCollectionSubmit);
            }
        });
    </script>
</body>
</html>
