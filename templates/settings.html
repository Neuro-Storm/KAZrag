
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Настройки</title>
    <link rel="stylesheet" href="https://unpkg.com/simpledotcss/simple.min.css">
    <style>
        .status-msg { padding: 1rem; margin-bottom: 1rem; border-radius: 4px; }
        .success { background-color: #d4edda; color: #155724; }
        .info { background-color: #cce5ff; color: #004085; }
        .error { background-color: #f8d7da; color: #721c24; }
        fieldset { margin-top: 1rem; }
        legend { font-weight: bold; }
        .grid-2col { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
        .grid-3col { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem; }
        .grid-4col { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 1rem; }
        .form-section { border: 1px solid #ccc; border-radius: 4px; padding: 1rem; margin-bottom: 1rem; }
        .form-section h3 { margin-top: 0; }
    </style>
</head>
<body>
    <header>
        <h1>Настройки и Управление</h1>
        <nav><a href="/">Поиск</a> <a href="/settings">Настройки</a></nav>
    </header>
    <main>
        {% if status or delete_status %}
            {% set msg = status or delete_status %}
            <div class="status-msg {{ 'success' if 'success' in msg or 'saved' in msg or 'indexed' in msg or 'deleted_' in msg or 'pdfs_processed' in msg else 'error' if 'fail' in msg or 'error' in msg else 'info' }}">
                {% if msg == 'saved' %}Настройки сохранены.{% endif %}
                {% if msg == 'indexed_successfully' %}Индексация успешно завершена!{% endif %}
                {% if msg == 'indexed_successfully_no_docs' %}Индексация завершена. Не найдено .txt/.md файлов для обработки.{% endif %}
                {% if 'error' in msg or 'fail' in msg or 'no_index_type' in msg %}Ошибка индексации. Проверьте логи терминала. Сообщение: {{ msg }}{% endif %}
                {% if 'deleted_' in msg and not 'delete_error' in msg %}Коллекция успешно удалена.{% endif %}
                {% if 'delete_error' in msg %}Ошибка при удалении коллекции: {{ msg.split('delete_error_')[-1].replace('_', ' ') }}{% endif %}
                {% if msg == 'error_no_collection_selected' %}Ошибка: Не выбрана коллекция для удаления.{% endif %}
                {% if 'pdfs_processed_successfully' in msg %}PDF файлы успешно обработаны!{% endif %}
                {% if 'pdf_processing_error' in msg %}Ошибка при обработке PDF. Проверьте логи терминала. Сообщение: {{ msg }}{% endif %}
            </div>
        {% endif %}
        
        <!-- Объединенная форма -->
        <form action="/update-settings" method="post">
            <input type="hidden" name="action" value="save_index_settings"> <!-- Значение по умолчанию, будет перезаписано JS или кнопкой -->
            
            <!-- Секция настроек индексации -->
            <div class="form-section">
                <h3>Настройки индексации</h3>
                
                <label for="folder_path">Папка для индексации (TXT и MD файлы)</label>
                <input type="text" id="folder_path" name="folder_path" value="{{ config.folder_path }}" required>
                
                <label for="collection_name">Имя новой коллекции</label>
                <input type="text" id="collection_name" name="collection_name" value="{{ config.collection_name }}" required>
                
                <label for="hf_model">Модель для плотных векторов (семантика)</label>
                <input list="model-history-dense" id="hf_model" name="hf_model" value="{{ config.current_hf_model }}" required>
                <datalist id="model-history-dense">
                    {% for model in config.hf_model_history %}
                        <option value="{{ model }}">{{ model }}</option>
                    {% endfor %}
                </datalist>
                
                <div class="grid-2col">
                    <div>
                        <label for="chunk_size">Размер чанка</label>
                        <input type="number" id="chunk_size" name="chunk_size" value="{{ config.chunk_size }}" required>
                    </div>
                    <div>
                        <label for="chunk_overlap">Перекрытие чанков</label>
                        <input type="number" id="chunk_overlap" name="chunk_overlap" value="{{ config.chunk_overlap }}" required>
                    </div>
                </div>
                
                <fieldset>
                    <legend>Типы векторов для индексации</legend>
                    <input type="checkbox" id="use_dense" name="use_dense" value="True" {% if config.use_dense_vectors %}checked{% endif %}>
                    <label for="use_dense">Плотные векторы (для семантического поиска)</label><br>
                </fieldset>
                
                <fieldset>
                    <legend>Устройство для индексации</legend>
                    <input type="radio" id="dev_auto" name="device" value="auto" {% if config.device == 'auto' %}checked{% endif %}>
                    <label for="dev_auto">Авто</label>
                    <input type="radio" id="dev_cuda" name="device" value="cuda" {% if config.device == 'cuda' %}checked{% endif %}>
                    <label for="dev_cuda">GPU</label>
                    <input type="radio" id="dev_cpu" name="device" value="cpu" {% if config.device == 'cpu' %}checked{% endif %}>
                    <label for="dev_cpu">CPU</label>
                </fieldset>
                
                <button type="submit" name="action" value="save_index_settings">Сохранить настройки индексации</button>
            </div>
        </form>
        
        <form action="/update-settings" method="post">
            <input type="hidden" name="action" value="save_mineru_settings"> <!-- Значение по умолчанию -->
            
            <!-- Секция настроек MinerU -->
            <div class="form-section">
                <h3>Настройки обработки PDF (MinerU - Subprocess)</h3>
                <p><strong>Важно:</strong> Убедитесь, что пакет `mineru` установлен и команда `mineru` доступна в вашем окружении.</p>
                
                <label for="mineru_input_pdf_dir">Папка с PDF файлами для обработки</label>
                <input type="text" id="mineru_input_pdf_dir" name="mineru_input_pdf_dir" value="{{ config.mineru_input_pdf_dir }}" required>
                
                <label for="mineru_output_md_dir">Папка для сохранения Markdown файлов (вход для индексации)</label>
                <input type="text" id="mineru_output_md_dir" name="mineru_output_md_dir" value="{{ config.mineru_output_md_dir }}" required>
                
                <div class="grid-3col">
                    <div>
                        <input type="checkbox" id="mineru_enable_formula_parsing" name="mineru_enable_formula_parsing" value="True" {% if config.mineru_enable_formula_parsing %}checked{% endif %}>
                        <label for="mineru_enable_formula_parsing">Парсинг формул</label>
                    </div>
                    <div>
                        <input type="checkbox" id="mineru_enable_table_parsing" name="mineru_enable_table_parsing" value="True" {% if config.mineru_enable_table_parsing %}checked{% endif %}>
                        <label for="mineru_enable_table_parsing">Парсинг таблиц</label>
                    </div>
                    <div>
                        <!-- Можно добавить другие опции, если понадобятся -->
                    </div>
                </div>
                
                <div class="grid-2col">
                    <div>
                        <label for="mineru_backend">Бэкенд обработки</label>
                        <select id="mineru_backend" name="mineru_backend" required>
                            <option value="pipeline" {% if config.mineru_backend == 'pipeline' %}selected{% endif %}>Pipeline</option>
                            <option value="vlm-transformers" {% if config.mineru_backend == 'vlm-transformers' %}selected{% endif %}>VLM Transformers</option>
                            <option value="vlm-sglang-client" {% if config.mineru_backend == 'vlm-sglang-client' %}selected{% endif %}>VLM SGLang Client</option>
                        </select>
                    </div>
                    <div>
                        <label for="mineru_method">Метод парсинга</label>
                        <select id="mineru_method" name="mineru_method" required>
                            <option value="auto" {% if config.mineru_method == 'auto' %}selected{% endif %}>Auto</option>
                            <option value="txt" {% if config.mineru_method == 'txt' %}selected{% endif %}>TXT</option>
                            <option value="ocr" {% if config.mineru_method == 'ocr' %}selected{% endif %}>OCR</option>
                        </select>
                    </div>
                </div>
                
                <div class="grid-2col">
                    <div>
                        <label for="mineru_lang">Язык для OCR</label>
                        <input type="text" id="mineru_lang" name="mineru_lang" value="{{ config.mineru_lang }}" required>
                    </div>
                    <div>
                        <label for="mineru_sglang_url">URL сервера SGLang (если backend=VLM SGLang Client)</label>
                        <input type="text" id="mineru_sglang_url" name="mineru_sglang_url" value="{{ config.mineru_sglang_url }}">
                    </div>
                </div>

                <fieldset>
                    <legend>Источник моделей для MinerU</legend>
                    <input type="radio" id="ms_hf" name="mineru_model_source" value="huggingface" {% if config.mineru_model_source == 'huggingface' %}checked{% endif %}>
                    <label for="ms_hf">Hugging Face</label>
                    <input type="radio" id="ms_ms" name="mineru_model_source" value="modelscope" {% if config.mineru_model_source == 'modelscope' %}checked{% endif %}>
                    <label for="ms_ms">ModelScope</label>
                    <input type="radio" id="ms_local" name="mineru_model_source" value="local" {% if config.mineru_model_source == 'local' %}checked{% endif %}>
                    <label for="ms_local">Локальные модели</label>
                </fieldset>
                
                <label for="mineru_models_dir">Путь к локальным моделям (если выбрано 'Локальные модели')</label>
                <input type="text" id="mineru_models_dir" name="mineru_models_dir" value="{{ config.mineru_models_dir }}">

                <button type="submit" name="action" value="save_mineru_settings">Сохранить настройки MinerU</button>
            </div>
        </form>
        
        <hr>
        
        <h2>Управление коллекциями</h2>
        <form action="/settings/delete-collection" method="post">
             <label for="collection_to_delete">Удалить коллекцию:
                <select id="collection_to_delete" name="collection_name" required>
                    <option value="">-- Выберите коллекцию --</option>
                    {% for c in collections %}
                        <option value="{{ c }}">{{ c }}</option>
                    {% endfor %}
                </select>
            </label>
            <button type="submit" onclick="return confirm('Вы уверены, что хотите удалить выбранную коллекцию? Это действие необратимо.');">Удалить</button>
        </form>
        
        <hr>
        
        <h2>Управление данными</h2>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
            <div>
                <h3>Обработка PDF</h3>
                <p>Преобразовать PDF из <strong>{{ config.mineru_input_pdf_dir }}</strong> в Markdown и сохранить в <strong>{{ config.mineru_output_md_dir }}</strong>.</p>
                <form action="/process-pdfs" method="post">
                    <button type="submit">Запустить обработку PDF (Subprocess)</button>
                </form>
            </div>
            <div>
                <h3>Управление индексом</h3>
                <p>Проиндексировать данные из <strong>{{ config.folder_path }}</strong> в коллекцию <strong>{{ config.collection_name }}</strong>.</p>
                <form action="/run-indexing" method="post">
                    <button type="submit">Запустить индексацию</button>
                </form>
            </div>
        </div>
    </main>
</body>
</html>
